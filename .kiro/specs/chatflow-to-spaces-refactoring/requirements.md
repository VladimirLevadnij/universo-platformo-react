# Требования к рефакторингу Chatflow в Spaces с множественными холстами

## Введение

Данная спецификация описывает масштабный рефакторинг функционала Chatflow в систему Spaces (Пространств) с поддержкой множественных холстов (Canvas). Проект основан на Flowise 2.2.8 с значительными доработками в изолированных приложениях папки `packages/` и модификациями основного функционала в `packages/`. 

Цель рефакторинга - переименовать сущность Chatflow в более подходящее название Spaces и добавить возможность создания нескольких холстов внутри одного пространства. Рефакторинг должен быть выполнен осторожно и пошагово, с минимальными изменениями в коде для сохранения совместимости с будущими обновлениями Flowise AI.

**Ключевые принципы:**
- Постепенный рефакторинг без массового переименования в коде
- Создание новой структуры БД без обратной совместимости (проект в разработке)
- Сохранение работоспособности существующего функционала Агентов, Ассистентов и публикации

## Требования

### Требование 1: Переименование сущности Chatflow в Spaces

**Пользовательская история:** Как пользователь платформы, я хочу работать с "Пространствами" вместо "Чат-потоков", чтобы название лучше отражало многофункциональную природу создаваемого контента.

#### Критерии приемки

1. КОГДА пользователь заходит в интерфейс, ТО система ДОЛЖНА отображать название "Spaces" ("Пространства") вместо "Chatflows" ("Чат-потоки")
2. КОГДА система генерирует URL для пространства, ТО URL ДОЛЖЕН содержать "/space/" вместо "/chatflow/"
3. КОГДА пользователь видит меню навигации, ТО пункт меню ДОЛЖЕН называться "Spaces" ("Пространства")
4. КОГДА система работает с базой данных, ТО таблица ДОЛЖНА называться "spaces" вместо "chat_flow"
5. ЕСЛИ пользователь использует русский язык интерфейса, ТО система ДОЛЖНА отображать "Пространства" вместо "Чат-потоки"

### Требование 2: Создание архитектуры множественных холстов

**Пользовательская история:** Как создатель контента, я хочу иметь возможность создавать несколько холстов внутри одного пространства, чтобы организовать сложные проекты в логические страницы.

#### Критерии приемки

1. КОГДА пользователь создает новое пространство, ТО система ДОЛЖНА автоматически создать первый холст по умолчанию
2. КОГДА пользователь находится в пространстве, ТО система ДОЛЖНА отображать вкладки для переключения между холстами
3. КОГДА пользователь добавляет новый холст, ТО система ДОЛЖНА создать новую вкладку с возможностью редактирования названия
4. КОГДА пользователь удаляет холст, ТО система ДОЛЖНА запросить подтверждение и удалить холст без возможности восстановления
5. ЕСЛИ в пространстве несколько холстов, ТО система ДОЛЖНА сохранять порядок холстов согласно пользовательской сортировке
6. КОГДА пользователь переключается между холстами, ТО система ДОЛЖНА сохранять состояние каждого холста независимо

### Требование 3: Структура базы данных для Spaces и Canvases

**Пользовательская история:** Как разработчик системы, я хочу иметь правильную структуру базы данных для поддержки пространств и холстов, чтобы обеспечить масштабируемость и производительность.

#### Критерии приемки

1. КОГДА система инициализируется, ТО ДОЛЖНА существовать таблица "spaces" с полями из текущей таблицы "chat_flow"
2. КОГДА система инициализируется, ТО ДОЛЖНА существовать таблица "canvases" с полями для хранения данных холста
3. КОГДА система инициализируется, ТО ДОЛЖНА существовать таблица связей "spaces_canvases" с полем порядка сортировки
4. КОГДА создается новое пространство, ТО система ДОЛЖНА автоматически создать связанный холст по умолчанию
5. ЕСЛИ удаляется пространство, ТО система ДОЛЖНА каскадно удалить все связанные холсты
6. КОГДА изменяется порядок холстов, ТО система ДОЛЖНА обновить поле сортировки в таблице связей

### Требование 4: Адаптация функционала публикации

**Пользовательская история:** Как пользователь, я хочу публиковать отдельные холсты из пространства, чтобы делиться конкретными страницами проекта.

#### Критерии приемки

1. КОГДА пользователь выбирает публикацию холста, ТО система ДОЛЖНА генерировать уникальную ссылку на основе UUID холста, по аналогии как раньше формировалась ссылка с UUID Chatflow.
2. КОГДА система публикует холст, ТО URL публикации ДОЛЖЕН содержать идентификатор холста, а не пространства
3. КОГДА пользователь переходит по ссылке опубликованного холста, ТО система ДОЛЖНА отображать только содержимое этого холста
4. ЕСЛИ холст удален, ТО опубликованная ссылка ДОЛЖНА возвращать ошибку 404
5. КОГДА пользователь публикует холст, ТО система ДОЛЖНА сохранять связь между публикацией и конкретным холстом

### Требование 5: Совместимость с существующим функционалом

**Пользовательская история:** Как пользователь существующих функций (Агенты, Ассистенты), я хочу, чтобы эти функции продолжали работать после рефакторинга, чтобы не потерять доступ к созданному контенту. При этом не нужен легаси код, не нужно сохранять поддержку старых данных и старой структуры данных, так как база данных в Supabase будет создана заново с нуля.

#### Критерии приемки

1. КОГДА система работает с Агентами, ТО функционал ДОЛЖЕН корректно работать с новой структурой Spaces
2. КОГДА система работает с Ассистентами, ТО функционал ДОЛЖЕН корректно работать с новой структурой Spaces  
3. КОГДА система работает с настройками, ТО все существующие настройки ДОЛЖНЫ быть совместимы с новой архитектурой
4. ЕСЛИ используется функционал публикации чатботов, ТО он ДОЛЖЕН работать с холстами внутри пространств


### Требование 6: Пользовательский интерфейс для управления холстами

**Пользовательская история:** Как пользователь, я хочу иметь интуитивный интерфейс для управления холстами в пространстве, чтобы эффективно организовывать свою работу.

#### Критерии приемки

1. КОГДА пользователь находится в пространстве, ТО система ДОЛЖНА отображать панель вкладок в нижней части интерфейса (вкладки идут снизу слева на право)
2. КОГДА пользователь кликает на кнопку "+" рядом с вкладками, ТО система ДОЛЖНА создать новый холст с названием по умолчанию
3. КОГДА пользователь дважды кликает на название вкладки, ТО система ДОЛЖНА позволить редактировать название холста
4. КОГДА пользователь кликает правой кнопкой на вкладку, ТО система ДОЛЖНА показать контекстное меню с опциями (переименовать, удалить, дублировать)
5. ЕСЛИ пользователь перетаскивает вкладку, ТО система ДОЛЖНА изменить порядок холстов
6. КОГДА в пространстве только один холст, ТО кнопка удаления ДОЛЖНА быть неактивной

### Требование 7: API для работы с Spaces и Canvases

**Пользовательская история:** Как разработчик интеграций, я хочу иметь API для работы с пространствами и холстами, чтобы создавать внешние инструменты и интеграции.

#### Критерии приемки

1. КОГДА выполняется GET запрос к /api/v1/spaces, ТО система ДОЛЖНА возвращать список всех пространств пользователя
2. КОГДА выполняется GET запрос к /api/v1/spaces/{id}/canvases, ТО система ДОЛЖНА возвращать все холсты пространства в правильном порядке
3. КОГДА выполняется POST запрос к /api/v1/spaces/{id}/canvases, ТО система ДОЛЖНА создать новый холст в пространстве
4. КОГДА выполняется PUT запрос к /api/v1/canvases/{id}, ТО система ДОЛЖНА обновить данные холста
5. КОГДА выполняется DELETE запрос к /api/v1/canvases/{id}, ТО система ДОЛЖНА удалить холст с проверкой прав доступа
6. ЕСЛИ запрос содержит некорректные данные, ТО система ДОЛЖНА возвращать соответствующие коды ошибок HTTP

### Требование 8: Архитектурное решение для миграции базы данных

**Пользовательская история:** Как архитектор системы, я хочу определить оптимальный подход к переименованию таблицы `chat_flow` в `spaces` и созданию новых таблиц, чтобы обеспечить чистую архитектуру без нарушения принципов изоляции приложений.

#### Критерии приемки

1. КОГДА выполняется переименование таблицы, ТО таблица `chat_flow` из миграции `packages/flowise-server/src/database/migrations/postgres/1693891895163-Init.ts` ДОЛЖНА быть переименована в `spaces`
2. КОГДА принимается решение о структуре, ТО система ДОЛЖНА либо создать новое приложение `packages/spaces-srv` (выглядит как приоритетный вариант, но требует изучения), либо использовать новую миграцию в `packages/space-builder-srv`
3. ЕСЛИ создается `packages/spaces-srv`, ТО функционал Chatflow ДОЛЖЕН постепенно переноситься из основного бэкенда Flowise в изолированное приложение, на данный момент нужно реализовать MVP этого функционала.
4. КОГДА создаются новые entities (Spaces, Canvas), ТО они ДОЛЖНЫ быть правильно зарегистрированы в центральном реестре `packages/flowise-server/src/database/entities/index.ts`
5. ЕСЛИ используется подход с новой миграцией в `packages/space-builder-srv`, ТО миграция ДОЛЖНА быть создана по аналогии с `packages/metaverse-srv/base/src/database`
6. КОГДА выполняется рефакторинг, ТО внутренние названия `chatflow` в коде МОГУТ остаться для минимизации изменений в Flowise
7. КОГДА создается новая структура БД, ТО старая структура Supabase ДОЛЖНА быть полностью заменена без обратной совместимости (проект в разработке)

### Требование 9: MVP план реализации

**Пользовательская история:** Как менеджер проекта, я хочу иметь четкий план MVP для минимально необходимых изменений, чтобы обеспечить работоспособность всех зависимых функций.

#### Критерии приемки

1. КОГДА определяется MVP, ТО ДОЛЖНЫ быть включены минимальные изменения для работы функционала Агентов с новой структурой
2. КОГДА определяется MVP, ТО ДОЛЖНЫ быть включены минимальные изменения для работы функционала Ассистентов с новой структурой  
3. КОГДА определяется MVP, ТО ДОЛЖЕН быть адаптирован функционал публикации чатботов для работы с холстами
4. КОГДА определяется MVP, ТО ДОЛЖНЫ быть сохранены все существующие настройки и конфигурации
5. ЕСЛИ функционал зависит от таблицы `chat_flow`, ТО он ДОЛЖЕН быть адаптирован для работы со связкой Spaces + Canvas
6. КОГДА реализуется MVP, ТО все критически важные функции ДОЛЖНЫ продолжать работать без перерывов

### Требование 10: Рефакторинг системы публикации для Canvas

**Пользовательская история:** Как пользователь системы публикации, я хочу публиковать отдельные холсты вместо целых пространств, чтобы делиться конкретными страницами проекта с точными ссылками.

#### Критерии приемки

1. КОГДА система публикации в `packages/publish-frt` и `packages/publish-srv` формирует ссылку, ТО она ДОЛЖНА использовать UUID Canvas вместо UUID Chatflow
2. КОГДА пользователь публикует холст, ТО система ДОЛЖНА создать отдельную публикацию для каждого холста
3. КОГДА формируется публичная ссылка, ТО URL ДОЛЖЕН содержать идентификатор конкретного холста
4. ЕСЛИ холст удаляется, ТО все связанные публикации ДОЛЖНЫ стать недоступными
5. КОГДА пользователь переходит по опубликованной ссылке холста, ТО система ДОЛЖНА отображать только содержимое этого конкретного холста
6. КОГДА выполняется рефакторинг публикации, ТО существующие опубликованные Chatflow ДОЛЖНЫ быть мигрированы как публикации первого холста соответствующего пространства

### Требование 11: Структура данных холстов и связей

**Пользовательская история:** Как разработчик, я хочу понимать точную структуру таблицы `canvases` и связей `spaces_canvases`, чтобы правильно реализовать функционал множественных холстов с сортировкой.

#### Критерии приемки

1. КОГДА создается таблица `canvases`, ТО она ДОЛЖНА содержать поля аналогичные текущей таблице `chat_flow` (flowData, deployed, isPublic, apiConfig, analytic, speechToText, categoryId, type, followUpPrompts)
2. КОГДА создается таблица связей `spaces_canvases`, ТО она ДОЛЖНА содержать поля: space_id, canvas_id, sort_order (начиная с 1)
3. КОГДА создается связь Space-Canvas, ТО система ДОЛЖНА автоматически назначать следующий порядковый номер в поле sort_order
4. ЕСЛИ изменяется порядок холстов перетаскиванием, ТО система ДОЛЖНА перенумеровать порядковые номера в поле sort_order
5. КОГДА удаляется холст, ТО система ДОЛЖНА автоматически пересчитать порядковые номера оставшихся холстов
6. КОГДА создается новое пространство, ТО система ДОЛЖНА автоматически создать первый холст с sort_order = 1
7. КОГДА выполняется запрос холстов пространства, ТО они ДОЛЖНЫ возвращаться отсортированными по полю sort_order

### Требование 12: Финальное состояние без совместимости с Chatflow

**Пользовательская история:** Как владелец продукта, я хочу, чтобы после завершения работ система не содержала наследия Chatflow, чтобы архитектура была чистой и понятной.

#### Критерии приемки

1. КОГДА развёрнута финальная версия, ТО в схеме БД НЕ ДОЛЖНО существовать таблицы `chat_flow`
2. КОГДА открывается Swagger/UI, ТО НЕ ДОЛЖНЫ присутствовать разделы/маршруты с префиксом `/chatflows`
3. КОГДА пользователь взаимодействует с интерфейсом, ТО НЕ ДОЛЖНЫ встречаться ключи i18n/надписи "Chatflow"/"Чат‑поток"
4. КОГДА просматривается документация (docs, README), ТО упоминания Chatflow ДОЛЖНЫ быть заменены на Spaces/Canvases
5. КОГДА формируются URL, ТО ДОЛЖНЫ использоваться новые паттерны `/spaces`, `/space/:id`, `/published/canvas/:canvasId`

### Требование 13: Безопасность и RLS‑политики (Supabase)

**Пользовательская история:** Как архитектор, я хочу строгие политики доступа на уровне строк для Spaces/Canvases, чтобы обеспечить безопасный мульти‑тенантный доступ.

#### Критерии приемки

1. КОГДА создаются таблицы `spaces`, `canvases`, `spaces_canvases`, ТО РЛС ДОЛЖЕН быть включён для всех трёх
2. КОГДА аутентифицированный пользователь делает SELECT, ТО доступ ДОЛЖЕН ограничиваться его участием в `user_uniks` соответствующего `unik_id`
3. КОГДА выполняются INSERT/UPDATE/DELETE, ТО они ДОЛЖНЫ быть разрешены ролям `owner|admin|editor` соответствующего Unik
4. КОГДА выполняются запросы с RLS, ТО наличие индексов на `spaces.unik_id`, `spaces_canvases.space_id`, `canvases.updated_date`, `canvases.apikeyid` ДОЛЖНО быть подтверждено
5. КОГДА включены RLS‑политики, ТО проверка через тестовые запросы ДОЛЖНА подтверждать недоступность чужих данных

### Требование 14: Шаблоны (Marketplace) — применение и сохранение

**Пользовательская история:** Как пользователь, я хочу применять готовые шаблоны и сохранять собственные холсты как шаблоны, чтобы ускорить создание проектов.

#### Критерии приемки

1. КОГДА применяется шаблон, ТО система ДОЛЖНА создать новый Canvas в выбранном Space (или создать Space+Canvas, если Space не указан)
2. КОГДА сохраняется шаблон, ТО система ДОЛЖНА экспортировать активный Canvas (name, flowData, meta) в таблицу шаблонов
3. КОГДА выполняется импорт шаблона, ТО система ДОЛЖНА корректно создать Canvas/Space согласно загруженному JSON
4. КОГДА выполняется экспорт шаблона, ТО формат ДОЛЖЕН соответствовать `CanvasExportV1` или `SpaceExportV1`
5. КОГДА открывается список шаблонов, ТО ДОЛЖНА отображаться информация, достаточная для поиска и выбора (name, tags, updatedDate)

### Требование 15: Дублирование, Импорт и Экспорт Space/Canvas

**Пользовательская история:** Как пользователь, я хочу быстро дублировать холсты и пространства, а также импортировать/экспортировать их в виде файлов, чтобы переносить и переиспользовать решения.

#### Критерии приемки

1. КОГДА дублируется Canvas, ТО создаётся новая запись с копией `flowData` и `sort_order = max + 1`
2. КОГДА дублируется Space (режим `withCanvases`), ТО создаётся новое Space и все его холсты копируются с сохранением порядка
3. КОГДА экспортируется Canvas/Space, ТО формируется корректный JSON (CanvasExportV1/SpaceExportV1)
4. КОГДА импортируется Canvas в Space, ТО создаётся новый Canvas с заданным именем и содержимым
5. КОГДА выполняется массовый импорт, ТО ошибки валидации ДОЛЖНЫ быть сообщены пользователю с деталями

### Требование 16: Структура API и неймспейсы

**Пользовательская история:** Как интегратор, я хочу консистентный набор REST‑эндпоинтов для Spaces и Canvases, чтобы легко автоматизировать операции.

#### Критерии приемки

1. КОГДА обращаемся к API, ТО базовый префикс ДОЛЖЕН быть `/uniks/:unikId/spaces`
2. КОГДА требуется управлять холстами, ТО ДОЛЖНЫ существовать эндпоинты создания/обновления/удаления Canvas и перестановки порядка (reorder)
3. КОГДА работаем с шаблонами, ТО ДОЛЖНЫ существовать эндпоинты `templates/apply`, `templates/save`, `templates/import`, `templates/export`
4. КОГДА система публикует холсты, ТО публичный URL ДОЛЖЕН быть `/published/canvas/:canvasId`
5. КОГДА деплоится финальная версия, ТО эндпоинтов `/chatflows*` НЕ ДОЛЖНО быть в публичном API

### Требование 17: Интерфейс и локализация

**Пользовательская история:** Как пользователь, я хочу видеть понятный UI с вкладками Canvas и корректными переводами на en/ru, чтобы удобно работать в пространстве.

#### Критерии приемки

1. КОГДА пользователь открывает Space, ТО интерфейс ДОЛЖЕН отображать вкладки Canvas с операциями создания/переименования/удаления/перетаскивания
2. КОГДА пользователь переключает язык, ТО ключи `spaces/space/canvas/canvases` ДОЛЖНЫ корректно переводиться на en/ru
3. КОГДА завершается рефакторинг, ТО ключи/надписи "Chatflow"/"Чат‑поток" НЕ ДОЛЖНЫ оставаться в UI

### Требование 18: Производительность и тестирование

**Пользовательская история:** Как инженер качества, я хочу, чтобы система работала быстро и была покрыта тестами, чтобы изменения были надёжными.

#### Критерии приемки

1. КОГДА выполняются операции списка/деталей Spaces/Canvases, ТО p95 времени ответа ДОЛЖЕН быть не хуже, чем у исходного решения на Chatflow
2. КОГДА выполняются RLS‑запросы, ТО планы запросов ДОЛЖНЫ использовать индексы (проверка EXPLAIN)
3. КОГДА запускаются тесты, ТО должны существовать unit/integration/E2E‑тесты на CRUD, reorder, шаблоны, импорт/экспорт и публикации
