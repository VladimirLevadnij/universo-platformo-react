# План реализации рефакторинга Chatflow в Spaces

## Фаза 1: Подготовка инфраструктуры

- [x] 1. Создание приложения apps/spaces-srv
  - Создать структуру директорий по аналогии с apps/metaverse-srv
  - Настроить package.json с зависимостями TypeORM и Express
  - Создать базовые конфигурационные файлы (tsconfig.json)
  - _Требования: 8.1, 8.2_

- [x] 2. Создание Entity классов для новой структуры данных
  - Создать Entity класс Space в apps/spaces-srv/base/src/database/entities/Space.ts
  - Создать Entity класс Canvas в apps/spaces-srv/base/src/database/entities/Canvas.ts  
  - Создать Entity класс SpaceCanvas в apps/spaces-srv/base/src/database/entities/SpaceCanvas.ts
  - Настроить связи между entities (OneToMany, ManyToOne)
  - _Требования: 3.1, 3.2, 11.1_

- [x] 3. Регистрация новых entities в центральном реестре
  - Экспортировать entities из apps/spaces-srv/base/src/database/entities/index.ts
  - Импортировать и зарегистрировать entities в packages/server/src/database/entities/index.ts
  - Проверить корректность регистрации через сборку проекта
  - _Требования: 8.3_

- [x] 4. Создание миграции для новых таблиц
  - Создать миграцию SpacesRefactoring в apps/spaces-srv/base/src/database/migrations/postgres/
  - Реализовать создание таблиц spaces, canvases, spaces_canvases с RLS политиками
  - Добавить индексы и ограничения целостности по аналогии с metaverse-srv
  - Зарегистрировать миграцию в центральном реестре packages/server/src/database/migrations/postgres/index.ts
  - Обеспечить совместимость с Supabase и существующей архитектурой Uniks
  - Удалить старую таблицу chat_flow (данные не нужны)
  - _Требования: 3.1, 3.2, 3.3, 11.2, 8.7_

- [x] 5. Создание базовых API endpoints для Spaces
  - Создать контроллер SpacesController с CRUD операциями
  - Реализовать GET /api/v1/spaces для получения списка пространств
  - Реализовать POST /api/v1/spaces для создания нового пространства
  - Реализовать GET /api/v1/spaces/:id для получения деталей пространства
  - _Требования: 7.1, 7.2_

- [x] 6. Создание базовых API endpoints для Canvas
  - Создать контроллер CanvasController с CRUD операциями
  - Реализовать GET /api/v1/spaces/:id/canvases для получения холстов пространства
  - Реализовать POST /api/v1/spaces/:id/canvases для создания нового холста
  - Реализовать PUT /api/v1/canvases/:id для обновления холста
  - Реализовать DELETE /api/v1/canvases/:id для удаления холста
  - _Требования: 7.3, 7.4, 7.5_

## Фаза 2: Адаптация зависимых систем

- [x] 7. Исправление ошибок компиляции в SpacesService
  - Исправлены ошибки TypeORM "No metadata for Space was found"
  - Реализован синглтон паттерн для SpacesService с правильной инициализацией DataSource
  - Исправлены все вызовы transaction с правильными типами EntityManager
  - Обновлены routes для использования синглтон паттерна
  - Проект успешно собирается без ошибок
  - _Требования: 8.1, 8.2, 8.3_

- [x] 8. Обновление функционала Ассистентов для работы с Canvas
  - Найти все места использования chatflowId в коде Ассистентов
  - Заменить chatflowId на canvasId в интерфейсах и API
  - Обновить логику создания и привязки Ассистентов к Canvas
  - Протестировать работу Ассистентов с новой структурой
  - _Требования: 5.2, 9.2_

- [x] 9. Адаптация системы публикации для Canvas
  - Обновить apps/publish-srv для работы с canvasId вместо chatflowId
  - Изменить генерацию URL публикации на /published/canvas/{canvasId}
  - Обновить логику получения данных для публикации из таблицы canvases
  - Адаптировать шаблоны AR.js Quiz и PlayCanvas MMOOMM для работы с Canvas
  - Обеспечить совместимость с существующими template packages (@universo/template-quiz, @universo/template-mmoomm)
  - Создать редиректы со старых URL на новые
  - _Требования: 4.1, 4.2, 10.1, 10.2_

- [x] 10. Обновление функционала публикации чатботов
  - Адаптировать логику публикации чатботов для работы с Canvas
  - Обновить конфигурации чатботов для ссылки на canvasId
  - Протестировать публикацию чатботов с новой структурой
  - _Требования: 5.4, 9.3_

## Фаза 3: Пользовательский интерфейс

- [x] 11. Обновление роутинга и URL структуры
  - Создать новые роуты /spaces, /space/:id в packages/ui
  - Добавить редиректы с /chatflows на /spaces и /chatflow/:id на /space/:id
  - Обновить навигационные ссылки в компонентах UI
  - Протестировать корректность всех переходов
  - _Требования: 1.2_

- [x] 12. Обновление переводов для новой терминологии
  - Обновить файлы переводов packages/ui/src/i18n/en.json и ru.json
  - Заменить "Chatflows" на "Spaces", "Чат-потоки" на "Пространства"
  - Добавить новые термины для Canvas ("Canvas", "Холст")
  - Обновить все компоненты для использования новых ключей переводов
  - _Требования: 1.1, 1.5_

- [x] 13. Обновление меню навигации
  - Изменить пункт меню с "Chatflows" на "Spaces"
  - Обновить иконки и стили для соответствия новой терминологии
  - Протестировать отображение меню на разных языках
  - _Требования: 1.3_

- [x] 14. Создание компонента вкладок для Canvas
  - Создать React компонент CanvasTabs для отображения вкладок холстов
  - Реализовать функционал переключения между холстами
  - Добавить кнопку "+" для создания нового холста
  - Реализовать inline редактирование названий вкладок
  - _Требования: 2.2, 2.3, 6.1, 6.2, 6.3_

- [x] 15. Реализация контекстного меню для вкладок
  - Добавить контекстное меню по правому клику на вкладку
  - Реализовать опции "Переименовать", "Дублировать", "Удалить"
  - Добавить подтверждение удаления холста
  - Заблокировать удаление последнего холста в пространстве
  - _Требования: 2.4, 6.4, 6.6_

- [x] 15.1. Исправление переключения между Canvas и подсветки активной вкладки
  - Добавлен useEffect для загрузки данных активного Canvas при переключении
  - Обновлена логика сохранения для работы с Canvas в режиме Space
  - Исправлена подсветка активной вкладки в CanvasTabs компоненте
  - Улучшены стили для активной вкладки (синий фон с белым текстом)
  - Проект успешно собран без ошибок
  - _Требования: 5.1, 5.2, 5.3_

## Фаза 4: Интеграция с существующими системами

- [ ] 16. Адаптация Space Builder для работы с Canvas
  - Обновить apps/space-builder-srv для создания Canvas вместо ChatFlow
  - Адаптировать генерацию UPDL узлов для новой структуры Canvas
  - Обеспечить совместимость с существующим функционалом prompt-to-flow
  - Протестировать создание Spaces через Space Builder
  - _Требования: 5.1, 5.2_

- [ ] 17. Обновление UPDL системы для Canvas
  - Адаптировать UPDL узлы (Space, Entity, Component, Event, Action, Data, Universo) для работы с Canvas
  - Обновить UPDLProcessor для обработки Canvas вместо ChatFlow
  - Обеспечить совместимость с существующими template packages
  - Протестировать экспорт UPDL из Canvas в различные технологии
  - _Требования: 5.1, 5.2_

- [ ] 18. Адаптация Analytics для Canvas
  - Обновить apps/analytics-frt для отслеживания Canvas вместо ChatFlow
  - Адаптировать метрики и отчеты для новой структуры
  - Обеспечить совместимость с существующими quiz analytics
  - _Требования: 5.3_

- [ ] 19. Обновление Metaverse интеграции
  - Адаптировать связи Metaverse с Canvas вместо ChatFlow
  - Обновить MetaverseLink для ссылок на Canvas
  - Обеспечить совместимость с существующим функционалом Metaverse
  - _Требования: 5.1, 5.2_

## Фаза 5: Множественные Canvas и финализация

- [ ] 20. Реализация функционала перетаскивания вкладок
  - Добавить drag & drop функционал для изменения порядка холстов
  - Реализовать визуальную индикацию при перетаскивании
  - Обновить sort_order в базе данных при изменении порядка
  - Протестировать корректность сортировки после перетаскивания
  - _Требования: 2.5, 6.5, 11.4_

- [ ] 21. Реализация независимого сохранения состояния Canvas
  - Обеспечить сохранение flowData для каждого холста отдельно
  - Реализовать автосохранение изменений в активном холсте
  - Добавить индикацию несохраненных изменений на вкладках
  - Протестировать переключение между холстами без потери данных
  - _Требования: 2.6_

- [ ] 22. Реализация API для управления порядком холстов
  - Создать endpoint PUT /api/v1/spaces/:id/canvases/reorder
  - Реализовать логику перенумерации sort_order при изменениях
  - Добавить валидацию корректности порядковых номеров
  - Обеспечить атомарность операций изменения порядка
  - _Требования: 7.6, 11.3, 11.4, 11.5_

- [ ] 23. Реализация публикации отдельных Canvas
  - Обновить UI для выбора конкретного холста для публикации
  - Реализовать генерацию уникальных URL для каждого опубликованного холста
  - Добавить управление публикациями на уровне отдельных холстов
  - Протестировать публикацию и доступность опубликованных холстов
  - _Требования: 4.1, 4.3, 4.5, 10.3_

- [ ] 24. Комплексное тестирование и оптимизация
  - Провести полное тестирование всего функционала Spaces и Canvas
  - Оптимизировать производительность запросов к новым таблицам
  - Добавить недостающие индексы для критических запросов
  - Провести нагрузочное тестирование с множественными холстами
  - _Требования: 18.1, 18.2, 18.3_

- [ ] 25. Обеспечение совместимости с архитектурой проекта
  - Убедиться в соответствии с принципами APPs Architecture (изоляция в apps/)
  - Проверить совместимость с Supabase JWT аутентификацией
  - Обеспечить работу с системой Uniks (workspace isolation)
  - Протестировать совместимость с существующими template packages
  - Проверить работу с многоязычностью (en/ru)
  - _Требования: все требования_

- [ ] 26. Документация и финализация
  - Обновить документацию API для новых endpoints
  - Создать руководство пользователя по работе с Spaces и Canvas (en/ru)
  - Обновить memory-bank с новой архитектурой Spaces
  - Подготовить release notes с описанием изменений
  - Обновить docs/en и docs/ru с новой терминологией
  - _Требования: 12.4, 16.1, 16.2, 16.3_