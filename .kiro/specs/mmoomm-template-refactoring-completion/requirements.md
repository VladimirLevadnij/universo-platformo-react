# Requirements Document

## Introduction

Данная спецификация описывает требования к завершению рефакторинга MMOOMM шаблона в проекте Universo Platformo React для **потоковой публикации/экспорта UPDL узлов в PlayCanvas** с поддержкой многопользовательского режима через Colyseus.

### Контекст проблемы

Проект находится в состоянии частично завершенного рефакторинга:

1. **Монолитный файл**: `PlayCanvasMMOOMMBuilder.ts` содержит 1357 строк кода, что затрудняет поддержку и развитие
2. **Дублирование логики**: При добавлении многопользовательского режима была создана отдельная логика вместо переиспользования существующих UPDL обработчиков
3. **Незавершенная модуляризация**: Создан пакет `@universo/template-mmoomm`, но интеграция не завершена, что приводит к ошибкам сборки
4. **Критические ошибки Colyseus**: Использование устаревшего API приводит к ошибкам JavaScript в браузере
5. **Отсутствие UI управления**: Нет возможности выбрать режим игры в интерфейсе публикации

### Основная цель

Завершить архитектурный рефакторинг системы потоковой публикации PlayCanvas MMOOMM, обеспечив:
- Модульную архитектуру с переиспользованием UPDL обработчиков
- Стабильную работу одиночного и многопользовательского режимов
- Удобный пользовательский интерфейс для выбора режима игры
- Исправление критических ошибок Colyseus API

## Requirements

### Requirement 1: Исправление критических ошибок сборки

**User Story:** Как разработчик, я хочу, чтобы проект успешно собирался без ошибок TypeScript, чтобы я мог продолжить разработку функционала.

#### Acceptance Criteria

1. WHEN выполняется команда `pnpm build` THEN сборка завершается успешно без ошибок TypeScript
2. WHEN импортируется `@universo/template-mmoomm` в `PlayCanvasMMOOMMBuilderV2.ts` THEN модуль корректно разрешается
3. WHEN вызывается метод `generateHTML` THEN сигнатура метода соответствует базовому классу `AbstractTemplateBuilder`
4. IF пакет `@universo/template-mmoomm` отсутствует в workspace THEN должен быть создан корректный экспорт в `index.ts`

### Requirement 2: Исправление Colyseus Client API совместимости

**User Story:** Как пользователь, я хочу, чтобы многопользовательский режим работал без ошибок JavaScript в браузере, чтобы я мог играть с другими игроками.

#### Acceptance Criteria

1. WHEN подключается к многопользовательскому серверу THEN не должно быть ошибок `Colyseus.getStateCallbacks is not a function`
2. WHEN используется Colyseus 0.16.x API THEN должны использоваться корректные методы `room.state.players.onAdd/onChange/onRemove`
3. WHEN подключается к серверу THEN URL должен определяться динамически на основе переменных окружения
4. WHEN загружается клиентский код THEN должен быть включен UMD скрипт `colyseus.js@0.16.4`
5. IF соединение не удается THEN должна отображаться понятная ошибка с возможностью повторной попытки

### Requirement 3: Рефакторинг монолитного PlayCanvasMMOOMMBuilder

**User Story:** Как разработчик, я хочу разбить монолитный файл `PlayCanvasMMOOMMBuilder.ts` (1357 строк) на модульную архитектуру, чтобы код был легко поддерживаемым и расширяемым.

#### Acceptance Criteria

1. WHEN рефакторится `PlayCanvasMMOOMMBuilder.ts` THEN основной файл должен содержать не более 300 строк кода
2. WHEN выносится функционал в модули THEN должны быть созданы отдельные классы для SP/MP режимов
3. WHEN создается пакет `@universo/template-mmoomm` THEN он должен содержать всю извлеченную логику
4. WHEN используется модульная архитектура THEN должен быть создан `HandlerManager` для переиспользования UPDL обработчиков
5. WHEN собирается пакет THEN должны создаваться как CommonJS, так и ESM версии
6. IF пакет используется в других приложениях THEN API должно быть стабильным и типобезопасным

### Requirement 4: Переиспользование UPDL обработчиков между SP/MP режимами

**User Story:** Как разработчик, я хочу, чтобы логика обработки UPDL узлов переиспользовалась между одиночным и многопользовательским режимами, чтобы избежать дублирования кода.

#### Acceptance Criteria

1. WHEN обрабатываются UPDL узлы в одиночном режиме THEN должны использоваться существующие обработчики
2. WHEN обрабатываются UPDL узлы в многопользовательском режиме THEN должны использоваться те же обработчики с сетевой адаптацией
3. WHEN создается `HandlerManager` THEN он должен предоставлять методы `processForSinglePlayer` и `processForMultiplayer`
4. WHEN изменяется логика обработчика THEN изменения должны применяться к обоим режимам автоматически
5. IF добавляется новый тип UPDL узла THEN он должен работать в обоих режимах без дополнительной настройки

### Requirement 5: Пользовательский интерфейс выбора режима игры

**User Story:** Как пользователь, я хочу иметь возможность выбрать режим игры (одиночный/многопользовательский) в интерфейсе публикации PlayCanvas, чтобы контролировать тип создаваемой игры.

#### Acceptance Criteria

1. WHEN открывается окно "Публикация и экспорт" И выбирается технология PlayCanvas И открывается вкладка "Публикация" THEN должна быть опция выбора режима игры
2. WHEN отображается селектор режима THEN должны быть доступны варианты: "Одиночный режим" и "Многопользовательский (Colyseus)"
3. WHEN выбирается "Одиночный режим" THEN должен генерироваться стандартный PlayCanvas проект без Colyseus
4. WHEN выбирается "Многопользовательский (Colyseus)" THEN должен генерироваться проект с поддержкой Colyseus и экраном ввода имени
5. WHEN сохраняется конфигурация публикации THEN выбранный режим должен сохраняться для повторного использования
6. IF режим не выбран THEN должен использоваться одиночный режим по умолчанию

### Requirement 6: Стабильная работа многопользовательского сервера

**User Story:** Как пользователь, я хочу, чтобы многопользовательский сервер работал стабильно и корректно обрабатывал подключения игроков.

#### Acceptance Criteria

1. WHEN запускается `pnpm start` THEN Colyseus сервер должен запускаться на порту из переменных окружения
2. WHEN игрок вводит имя и подключается THEN должно создаваться соединение с сервером
3. WHEN игрок двигается THEN позиция должна синхронизироваться с другими игроками
4. WHEN игрок добывает ресурсы THEN действие должно обрабатываться на сервере
5. WHEN игрок отключается THEN его данные должны корректно удаляться из состояния комнаты
6. IF сервер недоступен THEN должна отображаться понятная ошибка

### Requirement 7: Корректная передача UPDL объектов в многопользовательский режим

**User Story:** Как пользователь, я хочу видеть все объекты из UPDL Flow в многопользовательской игре, чтобы игровой мир соответствовал созданному дизайну.

#### Acceptance Criteria

1. WHEN создается многопользовательская игра из UPDL Flow THEN все Entity узлы должны передаваться на сервер
2. WHEN сервер получает данные сущностей THEN они должны корректно обрабатываться и создаваться в игровом мире
3. WHEN игрок подключается к игре THEN он должен видеть все объекты (корабли, станции, астероиды, ворота)
4. WHEN используется `UPDLProcessor.analyzeSpaceChain` THEN entities должны включаться в spaceData для multi-scene flows
5. IF данные сущностей отсутствуют THEN должны использоваться объекты по умолчанию с соответствующим предупреждением

### Requirement 8: Обратная совместимость и стабильность

**User Story:** Как разработчик, я хочу, чтобы все существующие функции продолжали работать после рефакторинга, чтобы не нарушить работу пользователей.

#### Acceptance Criteria

1. WHEN используется одиночный режим THEN все существующие функции должны работать как раньше
2. WHEN используется AR.js экспорт THEN он не должен быть затронут изменениями MMOOMM
3. WHEN используются другие шаблоны THEN они должны продолжать работать без изменений
4. WHEN выполняются существующие тесты THEN они должны проходить успешно
5. IF происходят ошибки THEN должны отображаться понятные сообщения об ошибках с инструкциями по исправлению

### Requirement 9: Документация и поддержка разработчиков

**User Story:** Как разработчик, я хочу иметь актуальную документацию по новой архитектуре, чтобы понимать, как работать с модульной системой.

#### Acceptance Criteria

1. WHEN создается пакет `@universo/template-mmoomm` THEN должен быть создан README с описанием API
2. WHEN изменяется архитектура THEN документация должна быть обновлена
3. WHEN добавляются новые возможности THEN должны быть примеры использования
4. WHEN происходят критические изменения THEN должно быть руководство по миграции
5. IF возникают проблемы THEN должны быть инструкции по отладке

### Requirement 10: Интеграция UI выбора режима в интерфейс публикации

**User Story:** Как пользователь, я хочу иметь интуитивный интерфейс для выбора режима игры в окне публикации PlayCanvas, чтобы легко переключаться между одиночным и многопользовательским режимами.

#### Acceptance Criteria

1. WHEN открывается компонент публикации PlayCanvas THEN должен отображаться селектор "Режим игры"
2. WHEN селектор отображается THEN должны быть доступны опции: "Одиночный" (по умолчанию) и "Многопользовательский (Colyseus)"
3. WHEN выбирается многопользовательский режим THEN должны отображаться дополнительные настройки Colyseus (хост, порт)
4. WHEN сохраняется конфигурация THEN выбранный режим должен передаваться в `BuildOptions`
5. WHEN происходит публикация THEN должен использоваться выбранный режим для генерации соответствующего HTML
6. IF настройки Colyseus не заданы THEN должны использоваться значения по умолчанию из переменных окружения

### Requirement 11: Производительность и оптимизация

**User Story:** Как пользователь, я хочу, чтобы игра работала плавно и быстро загружалась, независимо от выбранного режима.

#### Acceptance Criteria

1. WHEN загружается одиночный режим THEN не должны загружаться скрипты многопользовательского режима
2. WHEN загружается многопользовательский режим THEN размер HTML не должен превышать разумные пределы
3. WHEN происходит сборка THEN время сборки не должно значительно увеличиваться
4. WHEN используется модульная архитектура THEN не должно быть дублирования кода
5. IF происходят сетевые операции THEN они должны быть оптимизированы для минимальной задержки