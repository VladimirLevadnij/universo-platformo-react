# Multiplayer — [Статус: ✅ РЕАЛИЗОВАНО]

## Назначение

Авторитетный сервер реального времени для PlayCanvas-клиента: обработка интентов, расчёт состояния мира, рассылка снапшотов/дельт, античит.

## Реализованная архитектура

### Технологический стек

-   **Сервер**: Node.js + TypeScript + Colyseus (комнаты/состояние)
-   **Хранилище**: Supabase (PostgreSQL) — долговременные данные; Redis — presence/pubsub/скейлинг (планируется)
-   **Клиент**: PlayCanvas + colyseus.js (SDK), локальная предикция и реконсилиация

### Пакет: `@universo/multiplayer-colyseus-srv`

Полная реализация мультиплеерного сервера для Universo MMOOMM с поддержкой до 16 игроков в комнате.

## Клиент (PlayCanvas)

-   **Буферизация инпутов** с seq и clientTime
-   **Предикция локального движения**; интерполяция чужих сущностей
-   **Реконсилиация** по ack и снапшотам сервера
-   **Тайм-синхронизация** (оценка offset/RTT)

## Сервер (Colyseus Rooms)

### Реализованные функции

-   **MMOOMMRoom**: Основной класс комнаты с поддержкой 16 игроков
-   **Схемы Colyseus**: PlayerSchema, EntitySchema, MMOOMMRoomState
-   **Серверная авторизация**: Валидация добычи, торговли, движения
-   **UPDL интеграция**: Обработка объектов UPDL Flow в мультиплеере

### Игровая механика

-   **Система добычи**: Серверная валидация добычи ресурсов
-   **Торговая система**: Торговля на станциях с управлением кредитами
-   **Валидация движения**: Проверка границ позиции против читерства
-   **Управление сущностями**: Астероиды, станции, врата

## Протокол сообщений (реализован)

### Клиент → Сервер

-   `updateTransform`: Обновление позиции/поворота игрока
-   `startMining`: Запрос действия добычи
-   `sellAll`: Продажа всего инвентаря на станции

### Сервер → Клиент

-   **Синхронизация состояния** через схемы Colyseus
-   **Обновления в реальном времени** для игроков, астероидов, станций
-   **Игровые события**: завершение добычи, торговля

## Античит (реализован)

-   **Серверная авторизация** всех игровых действий
-   **Валидация движения** с проверкой границ
-   **Rate limiting** на действия клиента
-   **Валидация транзакций** для торговых операций

## Масштабирование

### Реализовано

-   **Изоляция по комнатам** для горизонтального масштабирования
-   **Управление жизненным циклом процессов** для стабильности
-   **Эффективная синхронизация состояния** с минимизацией трафика

### Планируется

-   **Redis presence/pubsub** для горизонтального масштабирования
-   **Шардинг по мирам/инстансам**; миграция сущностей между shard
-   **Периодические снапшоты состояния** в БД

## Интеграция с доменами

### Реализовано

-   **UPDL интеграция**: Поддержка объектов UPDL Flow в мультиплеере
-   **MultiplayerManager**: Интеграция с основным сервером Flowise
-   **Автоматическое обнаружение** режима мультиплеера в UPDL flows

### Планируется

-   `entities-srv`: инстансы ECS и компоненты
-   `combat-srv`: формулы урона/резисты, лаг-компенсация
-   `economy-srv`: кошельки/сделки (идемпотентность)

## Структура (реализована)

```
packages/multiplayer-colyseus-srv/base/
├── src/
│   ├── index.ts              # Точка входа сервера
│   ├── manager.ts            # Менеджер комнат
│   ├── rooms/
│   │   └── MMOOMMRoom.ts     # Основная реализация (377 строк)
│   ├── schemas/
│   │   ├── PlayerSchema.ts   # Схема игрока
│   │   ├── EntitySchema.ts   # Схема сущностей
│   │   └── MMOOMMRoomState.ts # Схема состояния комнаты
│   ├── integration/
│   │   └── MultiplayerManager.ts # Слой интеграции (165 строк)
│   └── utils/
│       └── logger.ts         # Утилиты логирования
└── README.md                 # Документация
```

## Быстрый старт

### Разработка

```bash
cd packages/multiplayer-colyseus-srv/base
pnpm install
pnpm dev
```

### Продакшн

```bash
pnpm build
pnpm start
```

## Конфигурация

### Переменные окружения

-   `PORT`: Порт сервера (по умолчанию: 2567)
-   `ENABLE_MULTIPLAYER_SERVER`: Включение мультиплеерного сервера
-   `MULTIPLAYER_SERVER_HOST`: Хост мультиплеерного сервера

### Интеграция с основным сервером

```typescript
// Автоматический запуск при ENABLE_MULTIPLAYER_SERVER=true
await multiplayerManager.start()
```

## Ссылки

-   **Предикция/rewind** (контекст Godot): [NetworkSynchronizer discussion #116](https://github.com/GameNetworking/NetworkSynchronizer/discussions/116)
-   **PlayCanvas + Colyseus**: [официальный туториал](https://developer.playcanvas.com/tutorials/real-time-multiplayer-colyseus/)
-   **Документация Colyseus**: [docs.colyseus.io](https://docs.colyseus.io/)

## Статус реализации

✅ **ЗАВЕРШЕНО** - Полная реализация мультиплеерного сервера для Universo MMOOMM

### Реализованные функции

-   [x] MMOOMMRoom с поддержкой 16 игроков
-   [x] Схемы Colyseus для типобезопасной синхронизации
-   [x] Серверная авторизация игрового процесса
-   [x] Интеграция с UPDL Flow объектами
-   [x] Система добычи и торговли
-   [x] Валидация движения и античит
-   [x] Интеграция с основным сервером Flowise
-   [x] Готовность к продакшену

### Планируемые улучшения

-   [ ] Redis presence для горизонтального масштабирования
-   [ ] Продвинутая игровая механика
-   [ ] Мониторинг производительности
-   [ ] Дополнительные меры безопасности
