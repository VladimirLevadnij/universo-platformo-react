# Общие пакеты

Universo Platformo использует модульную архитектуру с общими пакетами, которые предоставляют общую функциональность для нескольких приложений. Этот подход обеспечивает согласованность, уменьшает дублирование кода и упрощает сопровождение.

## Обзор

Общие пакеты расположены в директории `packages/` и следуют стандартизированной структуре:

- **Пакет типов** (`@universo-platformo/types`): Общие определения типов TypeScript
- **Пакет утилит** (`@universo-platformo/utils`): Общие утилитарные функции и процессоры
- **Пакеты шаблонов**: Специализированные пакеты для различных шаблонов экспорта

## Архитектура пакетов

### Двойная система сборки

Все общие пакеты используют двойную систему сборки, которая компилирует исходный код TypeScript в несколько форматов:

```
dist/
├── cjs/           # CommonJS модули (для Node.js)
├── esm/           # ES модули (для современных бандлеров)
└── types/         # Файлы объявлений TypeScript
```

Это обеспечивает максимальную совместимость в различных средах и бандлерах.

### Интеграция с workspace

Пакеты интегрированы с использованием PNPM workspaces с протоколом `workspace:*`:

```json
{
  "dependencies": {
    "@universo-platformo/types": "workspace:*",
    "@universo-platformo/utils": "workspace:*"
  }
}
```

## Основные пакеты

### Пакет типов

**Расположение**: `packages/universo-types/`
**Имя пакета**: `@universo-platformo/types`

Содержит все общие определения типов TypeScript и интерфейсы, используемые на платформе.

**Ключевые возможности**:
- Определения интерфейсов UPDL
- Согласованность типов на всей платформе
- Нулевые runtime зависимости
- Всеобъемлющее покрытие типами

**Использование**:
```typescript
import { IUPDLSpace, IUPDLData, IFlowData } from '@universo-platformo/types'
```

### Пакет утилит

**Расположение**: `packages/universo-utils/`
**Имя пакета**: `@universo-platformo/utils`

Предоставляет общие утилитарные функции и процессоры, используемые в нескольких приложениях.

**Ключевые возможности**:
- UPDLProcessor для конвертации данных потоков
- Поддержка обработки мультисцен
- Математические утилиты
- Помощники сериализации

**Использование**:
```typescript
import { UPDLProcessor } from '@universo-platformo/utils'

const result = UPDLProcessor.processFlowData(flowDataString)
```

## Пакеты шаблонов

Пакеты шаблонов предоставляют специализированную функциональность для различных форматов экспорта и случаев использования.

### Шаблон квизов

**Расположение**: `packages/template-quiz/`
**Имя пакета**: `@universo/template-quiz`

Специализированный пакет для создания образовательных квизов AR.js с возможностями сбора лидов.

### Шаблон MMOOMM

**Расположение**: `packages/template-mmoomm/`
**Имя пакета**: `@universo/template-mmoomm`

Специализированный пакет для создания космических MMO-опытов PlayCanvas с продвинутыми игровыми механиками.

## Руководство по разработке

### Создание новых общих пакетов

При создании новых общих пакетов следуйте этим рекомендациям:

1. **Расположение**: Размещайте в директории `packages/` с описательным именем
2. **Структура**: Используйте стандартную структуру поддиректории `base/`
3. **Система сборки**: Реализуйте двойную сборку (CJS + ESM + Types)
4. **Зависимости**: Минимизируйте внешние зависимости
5. **Документация**: Включайте исчерпывающие README файлы

### Соглашение об именовании пакетов

- **Пакеты платформы**: `@universo-platformo/package-name`
- **Пакеты шаблонов**: `@universo/template-name`
- **Пакеты приложений**: Используйте описательные имена без пространства имен

### Управление версиями

Все общие пакеты используют `workspace:*` для внутренних зависимостей, обеспечивая использование последней локальной версии во время разработки.

## Миграция с локальных реализаций

При миграции с локальных реализаций на общие пакеты:

1. **Обновите зависимости**: Добавьте общие пакеты в `package.json`
2. **Обновите импорты**: Измените пути импорта для использования имен пакетов
3. **Удалите локальные файлы**: Удалите дублированные локальные реализации
4. **Протестируйте интеграцию**: Проверьте функциональность с общими пакетами

## Лучшие практики

### Безопасность типов

Всегда используйте общие типы из `@universo-platformo/types` для обеспечения согласованности:

```typescript
// Хорошо
import { IUPDLSpace } from '@universo-platformo/types'

// Избегайте
interface LocalUPDLSpace { /* ... */ }
```

### Утилитарные функции

Предпочитайте общие утилиты локальным реализациям:

```typescript
// Хорошо
import { UPDLProcessor } from '@universo-platformo/utils'

// Избегайте
class LocalUPDLProcessor { /* ... */ }
```

### Интеграция шаблонов

Используйте систему реестра шаблонов для динамической загрузки шаблонов:

```typescript
import { TemplateRegistry } from '@universo/publish-frt'

const builder = TemplateRegistry.createBuilder('quiz')
```

## Сборка и тестирование

### Сборка всех общих пакетов

```bash
# Сборка всех общих пакетов
pnpm build --filter @universo-platformo/types
pnpm build --filter @universo-platformo/utils

# Сборка пакетов шаблонов
pnpm build --filter @universo/template-quiz
pnpm build --filter @universo/template-mmoomm
```

### Рабочий процесс разработки

1. Внесите изменения в исходный код общего пакета
2. Соберите пакет: `pnpm build --filter package-name`
3. Протестируйте в потребляющих приложениях
4. Зафиксируйте изменения после прохождения тестов

## Устранение неполадок

### Распространенные проблемы

**Ошибки импорта**: Убедитесь, что пакеты собраны перед импортом
**Конфликты типов**: Проверьте дублированные определения типов
**Сбои сборки**: Проверьте согласованность конфигурации TypeScript

### Советы по отладке

- Используйте `pnpm list` для проверки разрешения пакетов
- Проверьте директории `dist/` на наличие скомпилированного вывода
- Проверьте конфигурацию экспорта в `package.json`
