# Публикация чатботов с Canvas

## Обзор

Функционал публикации чатботов был обновлен для работы с новой структурой Canvas вместо устаревшей структуры Canvas. Этот документ описывает, как работает публикация чатботов с Canvas и миграция от Canvas.

## Изменения в архитектуре

### От Canvas к Canvas

- **Устаревшее**: Чатботы публиковались с использованием `canvasId` из таблицы `chat_flow`
- **Текущее**: Чатботы публикуются с использованием `canvasId` из таблицы `canvases`
- **Совместимость**: Система поддерживает как `canvasId`, так и `canvasId` для обратной совместимости

### Сопоставление сущностей

Сущность `Canvas` теперь ссылается на таблицу `canvases`:

```typescript
@Entity('canvases') // Рефакторинг: Canvas теперь ссылается на таблицу canvases
export class Canvas implements ICanvas {
    // ... поля сущности
    @Column({ nullable: true, type: 'text' })
    chatbotConfig?: string
    // ... другие поля
}
```

## Конфигурация чатбота

### Структура конфигурации

Конфигурация чатбота хранится в поле `chatbotConfig` Canvas в виде JSON строки:

```json
{
    "botType": "chat",
    "title": "Мой чат-бот",
    "backgroundColor": "#ffffff",
    "textColor": "#303235",
    "allowedOrigins": ["https://example.com"],
    "allowedOriginsError": "Этот сайт не имеет доступа к данному чатботу"
}
```

### Поля конфигурации

- `botType`: Тип бота (всегда "chat" для чатботов)
- `title`: Отображаемый заголовок чатбота
- `backgroundColor`: Цвет фона интерфейса чата
- `textColor`: Цвет текста интерфейса чата
- `allowedOrigins`: Массив разрешенных доменов для CORS
- `allowedOriginsError`: Пользовательское сообщение об ошибке для неавторизованных источников

## API эндпоинты

### Конфигурация бота

```
GET /api/v1/bots/:canvasId/config
```

Возвращает конфигурацию чатбота для указанного холста.

### Отображение бота

```
GET /api/v1/bots/:canvasId
```

Отображает интерфейс чатбота для указанного холста.

### Потоковая передача бота

```
GET /api/v1/bots/:canvasId/stream/:sessionId?
```

Обеспечивает потоковую функциональность чата для указанного холста.

## Интеграция с системой публикации

### Сервис публикации

Сервис публикации (`apps/publish-srv`) поддерживает как Canvas, так и устаревшие Canvas ID:

```typescript
// Новая публикация на основе Canvas
POST /publish/canvas
{
    "canvasId": "uuid-of-canvas",
    "generationMode": "streaming",
    "isPublic": true,
    "projectName": "Мой чатбот"
}

// Поддержка устаревшего Canvas (устарело)
POST /publish/arjs
{
    "canvasId": "uuid-of-canvas", // Фактически ссылается на canvas
    "generationMode": "streaming",
    "isPublic": true,
    "projectName": "Мой чатбот"
}
```

### Публичные URL

Опубликованные чатботы доступны по адресам:

- **Новый формат**: `/publish/canvas/public/:canvasId`
- **Устаревший формат**: `/publish/arjs/public/:publicationId` (перенаправляет на новый формат)

## Соображения по миграции

### Обратная совместимость

Система поддерживает обратную совместимость через:

1. **Сопоставление сущностей**: Сущность `Canvas` ссылается на таблицу `canvases`
2. **Совместимость ID**: Canvas ID используются там, где ранее использовались Canvas ID
3. **Поддержка API**: Принимаются как параметры `canvasId`, так и `canvasId`
4. **Перенаправления URL**: Устаревшие URL перенаправляются на новые URL на основе Canvas

### Миграция данных

При миграции от Canvas к Canvas:

1. Каждый Canvas становится Canvas с тем же ID
2. Поле `chatbotConfig` сохраняется как есть
3. Все конфигурации ботов продолжают работать без изменений
4. Существующие опубликованные боты остаются доступными

## Тестирование

### Модульные тесты

Тестируйте функциональность чатбота с помощью:

```bash
npm test -- chatbot-publication.test.ts
```

### Интеграционное тестирование

1. Создайте Canvas с конфигурацией чатбота
2. Проверьте получение конфигурации бота
3. Протестируйте отображение и потоковую передачу бота
4. Проверьте настройки CORS и безопасности

## Соображения безопасности

### Проверка источника

Чатботы проверяют разрешенные источники из `chatbotConfig`:

```typescript
if (canvas.chatbotConfig) {
    const parsedConfig = JSON.parse(canvas.chatbotConfig)
    const isValidAllowedOrigins = parsedConfig.allowedOrigins?.length && parsedConfig.allowedOrigins[0] !== ''
    // ... логика проверки источника
}
```

### Контроль доступа

- Боты требуют правильной аутентификации через систему Universo Platformo
- Разрешения на уровне Canvas применяются к доступу к чатботу
- Публичные боты учитывают флаг `isPublic` на Canvas

## Лучшие практики

1. **Проверка конфигурации**: Всегда проверяйте JSON `chatbotConfig` перед парсингом
2. **Обработка ошибок**: Предоставляйте понятные сообщения об ошибках конфигурации
3. **Безопасность**: Устанавливайте соответствующие `allowedOrigins` для продакшн развертываний
4. **Тестирование**: Тестируйте функциональность чатбота после обновлений Canvas
5. **Мониторинг**: Отслеживайте использование и метрики производительности чатбота

## Устранение неполадок

### Распространенные проблемы

1. **Бот не найден**: Проверьте, что Canvas существует и имеет установленный `chatbotConfig`
2. **Ошибки CORS**: Проверьте `allowedOrigins` в `chatbotConfig`
3. **Ошибки конфигурации**: Проверьте структуру JSON в `chatbotConfig`
4. **Проблемы с потоковой передачей**: Убедитесь, что Canvas помечен как `deployed` и `isPublic`

### Шаги отладки

1. Проверьте существование Canvas: `SELECT * FROM canvases WHERE id = 'canvas-id'`
2. Проверьте конфигурацию: Распарсите JSON `chatbotConfig`
3. Протестируйте эндпоинты бота: Используйте инструменты тестирования API
4. Проверьте логи: Просмотрите логи сервера для деталей ошибок