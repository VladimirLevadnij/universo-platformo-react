# Open WebUI

> **üìã –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**: –î–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Flowise –∏ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –¥–ª—è Universo Platformo React. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–∑–¥–µ–ª—ã –º–æ–≥—É—Ç –≤—Å–µ –µ—â–µ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å Flowise, –∫–æ—Ç–æ—Ä–∞—è –µ—â–µ –Ω–µ –±—ã–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π Universo Platformo.

> **üîÑ –°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–≤–æ–¥–∞**: –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω —Å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ—Ü–µ—Å—Å –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏. –ï—Å–ª–∏ –≤—ã –∑–∞–º–µ—Ç–∏–ª–∏ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ –ø–µ—Ä–µ–≤–æ–¥–µ –∏–ª–∏ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

[Open WebUI](https://github.com/open-webui/open-webui) - —ç—Ç–æ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è, –º–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏ —É–¥–æ–±–Ω–∞—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è _—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–º–µ—â–∞–µ–º–∞—è AI –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞_, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ.

[–§—É–Ω–∫—Ü–∏–∏](https://docs.openwebui.com/features/plugin/functions/) –ø–æ–¥–æ–±–Ω—ã –ø–ª–∞–≥–∏–Ω–∞–º –¥–ª—è Open WebUI. –ú—ã –º–æ–∂–µ–º —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é [Pipe —Ñ—É–Ω–∫—Ü–∏—é](https://docs.openwebui.com/features/plugin/functions/pipe), –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—ã –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã, –≤—ã–∑—ã–≤–∞—è Flowise Prediction API –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, Flowise –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ Open WebUI.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

1. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ Open WebUI, –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](https://docs.openwebui.com/getting-started/quick-start/). –í –ª–µ–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ **–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞**

<figure><img src="../../.gitbook/assets/image (4).png" alt="" width="235"><figcaption></figcaption></figure>

2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É **–§—É–Ω–∫—Ü–∏–∏** –∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é.

<figure><img src="../../.gitbook/assets/image (1) (1) (1).png" alt="" width="423"><figcaption></figcaption></figure>

3. –ù–∞–∑–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –∫–æ–¥:

```python
"""
title: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Flowise –¥–ª—è OpenWebUI
Requirements:
  - Flowise API URL (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ FLOWISE_API_URL)
  - Flowise API Key (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ FLOWISE_API_KEY)
"""

from pydantic import BaseModel, Field
from typing import Optional, Dict, Any, List, Union, Generator, Iterator
import requests
import json
import os


class Pipe:
    class Valves(BaseModel):
        flowise_url: str = Field(
            default=os.getenv("FLOWISE_API_URL", ""),
            description="Flowise URL",
        )
        flowise_api_key: str = Field(
            default=os.getenv("FLOWISE_API_KEY", ""),
            description="Flowise API –∫–ª—é—á –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏",
        )

    def __init__(self):
        self.type = "manifold"
        self.id = "flowise_chat"
        self.valves = self.Valves()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
        if not self.valves.flowise_url:
            print(
                "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à Flowise URL, –∏—Å–ø–æ–ª—å–∑—É—è –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è FLOWISE_API_URL"
            )
        if not self.valves.flowise_api_key:
            print(
                "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à Flowise API –∫–ª—é—á, –∏—Å–ø–æ–ª—å–∑—É—è –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è FLOWISE_API_KEY"
            )

    def pipes(self):
        if self.valves.flowise_api_key and self.valves.flowise_url:
            try:
                headers = {
                    "Authorization": f"Bearer {self.valves.flowise_api_key}",
                    "Content-Type": "application/json",
                }

                r = requests.get(
                    f"{self.valves.flowise_url}/api/v1/chatflows?type=AGENTFLOW",
                    headers=headers,
                )
                models = r.json()
                return [
                    {
                        "id": model["id"],
                        "name": model["name"],
                    }
                    for model in models
                ]

            except Exception as e:
                return [
                    {
                        "id": "error",
                        "name": e,
                    },
                ]
        else:
            return [
                {
                    "id": "error",
                    "name": "API –∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.",
                },
            ]

    def _process_message_content(self, message: dict) -> str:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç"""
        if isinstance(message.get("content"), list):
            processed_content = []
            for item in message["content"]:
                if item["type"] == "text":
                    processed_content.append(item["text"])
            return " ".join(processed_content)
        return message.get("content", "")

    def pipe(
        self, body: dict, __user__: Optional[dict] = None, __metadata__: dict = None
    ) -> Union[str, Generator, Iterator]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Ç-—Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Flowise"""
        try:
            print("\n–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ Flowise:")
            print(f"–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞: {json.dumps(body, indent=2)}")

            stream_enabled = body.get("stream", True)

            session_id = __metadata__['chat_id']

            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ id –º–æ–¥–µ–ª–∏ –∏–∑ –∏–º–µ–Ω–∏ –º–æ–¥–µ–ª–∏
            model_id = body["model"][body["model"].find(".") + 1 :]

            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —Ç–µ–ª–∞
            messages = body.get("messages", [])
            if not messages:
                raise Exception("–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞")

            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
            current_message = messages[-1]
            question = self._process_message_content(current_message)

            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ñ–æ—Ä–º–∞—Ç—É Flowise API
            data = {
                "question": question,  # –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                "overrideConfig": {
                    "sessionId": session_id
                },  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è,
                "streaming": stream_enabled
            }

            headers = {
                "Authorization": f"Bearer {self.valves.flowise_api_key}",
                "Content-Type": "application/json",
            }

            print("\n–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ Flowise API:")
            print(f"URL: {self.valves.flowise_url}")
            print(f"–ó–∞–≥–æ–ª–æ–≤–∫–∏: {headers}")
            print(f"–î–∞–Ω–Ω—ã–µ: {json.dumps(data, indent=2)}")

            # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–∞
            r = requests.post(
                url=f"{self.valves.flowise_url}/api/v1/prediction/{model_id}",
                json=data,
                headers=headers
            )
            r.raise_for_status()

            # –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏
            if stream_enabled:
                for line in r.iter_lines(decode_unicode=True):
                    if line and line.startswith('data:'):
                        try:
                            # –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ 'data:' –∏ –ø–∞—Ä—Å–∏–Ω–≥ JSON
                            json_data = line[5:]  # –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ 'data:'
                            response = json.loads(json_data)
                            
                            # –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∏–∑ —Å–æ–±—ã—Ç–∏–π —Ç–æ–∫–µ–Ω–æ–≤
                            if isinstance(response, dict) and response.get("event") == "token":
                                token_data = response.get("data", "")
                                if token_data:  # –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
                                    yield token_data
                        except json.JSONDecodeError:
                            # –ü—Ä–æ–ø—É—Å–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö JSON —Å—Ç—Ä–æ–∫
                            continue
            else:
                response = r.json()
                # –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è –∏–∑ –æ—Ç–≤–µ—Ç–∞
                if isinstance(response, dict) and "text" in response:
                    return response["text"]
                return ""

        except Exception as e:
            error_msg = f"–û—à–∏–±–∫–∞ –≤ Flowise pipe: {str(e)}"
            print(error_msg)
            return error_msg

```

4. –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∫–ª—é—á–∏—Ç–µ –µ—ë –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫, —á—Ç–æ–±—ã –≤–≤–µ—Å—Ç–∏ –≤–∞—à Flowise URL –∏ Flowise API –∫–ª—é—á:

<figure><img src="../../.gitbook/assets/image (2) (1) (1).png" alt="" width="563"><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (3) (1).png" alt="" width="431"><figcaption></figcaption></figure>

5. –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—ã –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –Ω–∞–∂–º–µ—Ç–µ "–ù–æ–≤—ã–π —á–∞—Ç", –≤—ã —Å–º–æ–∂–µ—Ç–µ —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Ç–æ–∫–æ–≤. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–¥, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å:

* –¢–æ–ª—å–∫–æ Agentflows V2: `f"{self.valves.flowise_url}/api/v1/chatflows?type=AGENTFLOW"`
* –¢–æ–ª—å–∫–æ Chatflows: `f"{self.valves.flowise_url}/api/v1/chatflows?type=CHATFLOW"`
* –¢–æ–ª—å–∫–æ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–≤: `f"{self.valves.flowise_url}/api/v1/chatflows?type=ASSISTANT"`

<figure><img src="../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

6. –¢–µ—Å—Ç:

<figure><img src="../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>
