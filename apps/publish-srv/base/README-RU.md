# Сервер публикации (AR.js MVP)

Минимальное серверное приложение для публикации пространств AR.js, основанных на узлах UPDL, интегрированное с основным сервером Flowise.

## Функциональность

- Создание публикаций AR.js через потоковую генерацию пространства
- Получение данных пространства для отрисовки AR.js

## Структура проекта

```
apps/publish-srv/base/
└─ src/
   ├─ controllers/       # Контроллеры публикации AR.js
   ├─ routes/            # Маршруты API
   ├─ interfaces/        # Интерфейсы TypeScript
   ├─ middlewares/       # Обработчики ошибок
   ├─ utils/             # Логгер
   ├─ server.ts          # Инициализация маршрутов
   └─ index.ts           # Точка входа
```

## Интеграция с основным сервером Flowise

Статические библиотеки AR.js обслуживаются главным сервером:

```typescript
const publishFrtAssetsPath = path.join(__dirname, '../../../apps/publish-frt/base/dist/assets')
this.app.use('/assets', express.static(publishFrtAssetsPath))
```

## Процесс публикации AR.js

1. Пользователь создаёт чатфлоу с узлами UPDL
2. Через интерфейс выбирает источники библиотек
3. Нажимает «Publication and Export» → «AR.js» → «Make Public»
4. Сервер создаёт публикацию с выбранной конфигурацией
5. Пользователь получает ссылку вида `/p/:chatflowId`
6. По этой ссылке фронтенд запрашивает данные пространства и `libraryConfig`
7. Генерируется HTML с выбранными библиотеками
8. **Важно:** фронтенд отображает HTML в iframe

### Баллы и лиды

При завершении квиза результат возвращается на фронтенд и временно сохраняется в таблице `lead` Supabase в поле `phone`. В дальнейшем будет добавлено отдельное поле для результатов.

## Поток конфигурации библиотек

1. Пользователь выбирает источники библиотек в UI
2. Настройки сохраняются в `chatbotConfig.arjs.libraryConfig`
3. `utilBuildUPDLflow` возвращает конфигурацию вместе с пространством
4. `ARJSBuilder` использует её при генерации HTML

### Поддерживаемые источники

- **Официальный CDN**
- **Локальный сервер Kiberplano** (`/assets/libs/`)

## Деморежим

Деморежим реализован только во фронтенде через константу `DEMO_MODE`.

## Зависимости

- Основной сервер Flowise
- Функция `utilBuildUPDLflow`
- Путь `/assets` для статических файлов

## Преимущества архитектуры

1. Единая инфраструктура без отдельного статического сервера
2. Возможность работы без CDN
3. Выбор источников библиотек без изменения кода
4. Оптимальная производительность
5. Простота развёртывания

---

_Universo Platformo | Сервер публикации AR.js_
