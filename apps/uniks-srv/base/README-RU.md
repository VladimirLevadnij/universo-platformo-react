# Uniks Server (uniks-srv)

Бекенд workspace-пакет для функциональности управления рабочими пространствами в экосистеме Universo Platformo.

## Обзор

Uniks Server - это бекенд workspace-пакет (`@universo/uniks-srv`), который предоставляет функциональность управления рабочими пространствами. Он обрабатывает CRUD операции с рабочими пространствами, управление участниками и интегрируется с основным сервером Flowise для предоставления workspace-специфичной маршрутизации.

## Ключевые возможности

-   **CRUD операции с рабочими пространствами**: Создание, чтение, обновление и удаление рабочих пространств
-   **Управление участниками**: Добавление и удаление участников рабочих пространств
-   **Интеграция с базой данных**: TypeORM сущности и миграции PostgreSQL
-   **Аутентификация**: Интеграция с Supabase для аутентификации пользователей
-   **Интеграция роутов**: Вложенное монтирование роутов под префиксом `/:unikId`
-   **Типобезопасность**: Полная поддержка TypeScript с декларациями типов

## Структура

```
src/
├── routes/         # Express роуты для операций с Uniks
│   └── uniksRoutes.ts  # Основной роутер с CRUD эндпоинтами
├── database/       # Файлы, связанные с базой данных
│   ├── entities/   # Определения TypeORM сущностей
│   └── migrations/ # Файлы миграций PostgreSQL
├── types/          # TypeScript декларации типов
│   └── flowiseRoutes.d.ts  # Декларации внешних модулей
└── index.ts        # Точка входа пакета
```

## API эндпоинты

### Управление рабочими пространствами

-   `GET /uniks` - Список всех рабочих пространств для аутентифицированного пользователя
-   `POST /uniks` - Создание нового рабочего пространства
-   `GET /uniks/:id` - Получение деталей рабочего пространства
-   `PUT /uniks/:id` - Обновление рабочего пространства
-   `DELETE /uniks/:id` - Удаление рабочего пространства

### Управление участниками

-   `POST /uniks/members` - Добавление участника в рабочее пространство
-   `DELETE /uniks/members/:userId` - Удаление участника из рабочего пространства
-   `GET /uniks/:id/members` - Список участников рабочего пространства

## Схема базы данных

### Сущность Unik

```typescript
interface Unik {
    id: string
    name: string
    description?: string
    owner_id: string
    created_at: Date
    updated_at: Date
}
```

### Сущность UserUnik

```typescript
interface UserUnik {
    id: string
    user_id: string
    unik_id: string
    role: 'owner' | 'member'
    created_at: Date
}
```

## Интеграция

Этот пакет интегрируется с:

-   **Основным сервером**: Предоставляет роуты рабочих пространств основному серверу Flowise
-   **Supabase**: Использует сервисы аутентификации и базы данных
-   **TypeORM**: ORM базы данных для управления сущностями
-   **Express**: Веб-фреймворк для обработки роутов

## Разработка

### Предварительные требования

-   Node.js 18+
-   Менеджер пакетов PNPM
-   База данных PostgreSQL
-   Доступ к проекту Supabase

### Установка

```bash
# Установка зависимостей
pnpm install

# Сборка пакета
pnpm build

# Запуск в режиме разработки
pnpm dev
```

### Команды сборки

```bash
# Сборка для продакшена
pnpm build

# Сборка в режиме наблюдения
pnpm dev

# Сборка конкретного пакета
pnpm build --filter @universo/uniks-srv
```

## Конфигурация

Пакет использует следующую конфигурацию:

-   **TypeScript**: Включена строгая проверка типов
-   **TypeORM**: Конфигурация ORM базы данных
-   **Express**: Настройка веб-фреймворка
-   **Supabase**: Интеграция аутентификации и базы данных

## Зависимости

### Основные зависимости

-   `express`: Веб-фреймворк
-   `typeorm`: ORM базы данных
-   `pg`: Драйвер PostgreSQL
-   `@supabase/supabase-js`: Supabase клиент

### Зависимости разработки

-   `typescript`: TypeScript компилятор
-   `@types/express`: TypeScript определения для Express
-   `@types/node`: TypeScript определения для Node.js

## Миграции базы данных

Пакет включает миграции PostgreSQL для:

-   Создания таблицы `uniks`
-   Создания таблицы `user_uniks`
-   Настройки правильных индексов и ограничений
-   Добавления связей внешних ключей

## Декларации типов

Пакет предоставляет TypeScript декларации для внешних модулей:

-   `flowiseRoutes.d.ts`: Декларации для модулей роутов Flowise
-   Интерфейсы сущностей для моделей базы данных
-   Типы API запросов/ответов

## Безопасность

-   **Аутентификация**: Все роуты требуют валидные JWT токены Supabase
-   **Авторизация**: Операции с рабочими пространствами ограничены владельцами/участниками
-   **Защита от SQL инъекций**: Использование параметризованных запросов TypeORM
-   **Валидация ввода**: Валидация запросов для всех эндпоинтов

## Обработка ошибок

Пакет реализует комплексную обработку ошибок:

-   **Ошибки базы данных**: Правильные ответы об ошибках для операций с базой данных
-   **Ошибки аутентификации**: 401 ответы для невалидных токенов
-   **Ошибки авторизации**: 403 ответы для неавторизованного доступа
-   **Ошибки валидации**: 400 ответы для невалидных входных данных

## Вклад в разработку

При вкладе в этот пакет:

1. Следуйте TypeScript лучшим практикам
2. Поддерживайте совместимость миграций базы данных
3. Добавляйте правильную обработку ошибок
4. Включайте TypeScript определения типов
5. Следуйте стандартам кодирования проекта

## Связанная документация

-   [Документация основных приложений](../README-RU.md)
-   [Документация Uniks Frontend](../uniks-frt/base/README-RU.md)
-   [Архитектура платформы](../../../docs/ru/applications/README.md)

---

**Universo Platformo | Пакет Uniks Server**
