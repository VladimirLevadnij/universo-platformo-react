# Space Builder Frontend (Фронтенд)

Компоненты UI для генерации графа из текстового запроса (Spaces/Chatflow) в Universo Platformo.

## Обзор

Пакет предоставляет переиспользуемые React‑компоненты:

-   SpaceBuilderFab: плавающая кнопка для открытия диалога генерации
-   SpaceBuilderDialog: модальное окно для ввода запроса; выбор модели перенесён в модалку по кнопке‑шестерёнке
-   Хук `useSpaceBuilder` для вызова серверного API (`/api/v1/space-builder/prepare`, `/api/v1/space-builder/revise`, `/api/v1/space-builder/generate`)
-   Помощник i18n `registerSpaceBuilderI18n` для слияния переводов (EN/RU) в хост‑приложение

## Детерминированный билдер (стабильный результат)

-   Финальный UPDL‑граф строится локальным детерминированным билдером из валидированного плана квиза (на этом этапе LLM не используется).
-   Это стабилизирует результат, исключает галлюцинации и снижает расход токенов.
-   Именование узлов и расстановка координат полностью выполняются нашим билдером.

## Переменные окружения

UI Space Builder читает серверную конфигурацию, чтобы включать тестовый режим:

-   На сервере (`packages/server/.env`):
    -   `SPACE_BUILDER_TEST_MODE=true|false` — включает синтетический пункт провайдера "Test mode" в UI
    -   `GROQ_TEST_API_KEY=<key>` — необязательный ключ для тестового режима (используется только если режим включён)
-   Эндпоинт: `GET /api/v1/space-builder/config` (требуется авторизация) возвращает `{ testMode: boolean }`

Модели на основе Credentials подтягиваются из существующих учетных данных Flowise (OpenAI, AzureOpenAI, Groq) и отображаются в выпадающем списке моделей.

## Поведение (режим создания графа)

-   В настройках генерации есть поле «Вариант создания графа» с тремя вариантами:
    -   «Очистить граф в текущем пространстве» — полностью заменяет текущий холст новым графом
    -   «Создать новое пространство» — если на холсте есть узлы, открывает новую вкладку с пустым Chatflow и передает туда сгенерированный граф (через `localStorage`), иначе действует как замена в текущем
    -   «Добавить граф в текущее пространство (отдельные узлы)» — добавляет новые узлы в текущий холст с ремапом ID и безопасным смещением вниз

## Зачем нужен `tsconfig.esm.json`

Пакет используется как библиотека внутри редактора Flow. Чтобы улучшить бандлинг и tree‑shaking в ESM‑инструментах (Vite/ESBuild), собираем два таргета:

-   `tsconfig.json` → CommonJS‑сборка в `dist/`
-   `tsconfig.esm.json` → ESM‑сборка в `dist/esm/`

Поле `exports` в `package.json` указывает импортам на ESM, а `require` — на CJS. Это предотвращает проблемы interop и уменьшает размер бандла. Если необходим один таргет, можно убрать ESM‑шаг и `exports.import`, но качество tree‑shaking может снизиться.

## Использование

1. Подключите пакет как зависимость воркспейса и соберите его.
2. Один раз зарегистрируйте переводы при старте приложения и отрендерьте FAB на холсте.

```ts
// Регистрация переводов
import i18n from '@/i18n'
import { registerSpaceBuilderI18n } from '@universo/space-builder-frt'
registerSpaceBuilderI18n(i18n)
```

```tsx
// Рендер FAB и обработка onApply
import { SpaceBuilderFab } from '@universo/space-builder-frt'
;<SpaceBuilderFab
    models={availableChatModels}
    onApply={(graph, mode) => {
        if (mode === 'append') return handleAppendGeneratedGraphBelow(graph)
        if (mode === 'newSpace') return handleNewSpaceFromGeneratedGraph(graph)
        handleApplyGeneratedGraph(graph) // replace
    }}
/>
```

## Команды

-   `pnpm build` — компиляция TS (CJS + ESM) и копирование ассетов через gulp
-   `pnpm dev` — watch TypeScript (без копирования ассетов)
-   `pnpm lint` — проверка ESLint

## Примечания

-   Изолируйте UI‑код от серверных зависимостей
-   Для авторизованных запросов используйте общий Axios‑клиент хост‑приложения
-   Секреты не хранятся в этом пакете; ключи моделей резолвятся на стороне сервера

## Трёхшаговый сценарий (Подготовить → Предпросмотр → Настройки → Сгенерировать)

1. Подготовить

-   Вставьте учебный материал (лимит 5000 символов)
-   При необходимости укажите «Дополнительные условия» (лимит 500 символов), которые строго направляют LLM
-   Укажите количество вопросов (1–10, по умолчанию 1) и ответов на вопрос (2–5, по умолчанию 2)
-   Нажмите «Подготовить» → UI вызывает `POST /api/v1/space-builder/prepare` и получает `quizPlan`

2. Предпросмотр

-   Диалог показывает предложенные вопросы и ответы в нередактируемом текстовом поле (ровно один правильный на вопрос)
-   Поле «Что изменить?» (лимит 500 символов) позволяет запросить точечные правки через `/revise`; поле очищается после успешного применения и при возврате «Назад» с повторной подготовкой
-   Можно нажать «Назад», чтобы изменить исходный текст или параметры

3. Настройки

-   Нажмите «Настроить», чтобы перейти к настройкам генерации (режим создания графа/собирать имена/показывать финал)
-   Выбор модели доступен через иконку‑шестерёнку внизу слева (модалка «Настройки модели»)

4. Сгенерировать

-   Нажмите «Сгенерировать» → UI вызывает `POST /api/v1/space-builder/generate` с `quizPlan`
-   Полученный UPDL‑граф применяется согласно выбранному режиму (Append / Replace / New Space)

Примечания:

-   В тестовом режиме (`SPACE_BUILDER_TEST_MODE=true` на сервере), если хост‑приложение не предоставляет моделей, UI подставляет синтетический провайдер `Groq Test: llama-3-8b-8192`, чтобы функция работала без пользовательских ключей.
-   В тестовом режиме сервер всегда использует Groq Test провайдера вне зависимости от выбранной модели; в модалке «Настройки модели» отображается предупреждение.
-   Эндпоинты защищены; клиент автоматически обновляет токен при 401 и повторяет запрос.
