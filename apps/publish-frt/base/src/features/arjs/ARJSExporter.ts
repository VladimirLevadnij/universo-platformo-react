/**
 * ARJSExporter - Exports UPDL scenes to AR.js/A-Frame HTML
 * Handles proper scene structure, including automatic camera and lighting
 */

// Universo Platformo | UPDL AR.js Exporter
import { UPDLScene, UPDLObject, UPDLCamera, UPDLLight, Vector3, Color } from '../../api/updlApi'
import { UPDLToARJSConverter } from './converters/UPDLToARJS'
import { AFrameScene, createDefaultScene, createHiroMarker } from '../aframe/models/AFrameModel'
import { BaseAFrameExporter, AFrameExportOptions } from '../exporters/BaseAFrameExporter'
import { ARJSHTMLGenerator } from './generators/ARJSHTMLGenerator'

// A-Frame component versions to use
const AFRAME_VERSION = '1.4.2'
const ARJS_VERSION = '3.4.5'

// AR.js specific export options
export interface ARJSExportOptions {
    title?: string
    markerType?: 'pattern' | 'barcode' | 'custom'
    markerValue?: string
    includeStats?: boolean
    autoRotate?: boolean
}

// Marker types supported by AR.js
export enum MarkerType {
    PATTERN = 'pattern',
    BARCODE = 'barcode',
    CUSTOM = 'custom'
}

// Preset pattern marker values
export const PATTERN_PRESETS = {
    HIRO: 'hiro',
    KANJI: 'kanji'
}

/**
 * AR.js exporter
 */
class ARJSExporter {
    /**
     * Generate HTML for AR.js from a UPDL scene
     * @param scene UPDL scene to export
     * @param options Export options
     * @returns Generated HTML
     */
    generateHTML(scene: UPDLScene, options: ARJSExportOptions = {}): string {
        if (!scene) {
            throw new Error('Scene is required for HTML generation')
        }

        // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ø–æ—Ç–æ–∫–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π
        // –ï—Å–ª–∏ —Å—Ü–µ–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–∑–ª—ã, –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∏—Ö –≤ UPDL —Å—Ü–µ–Ω—É
        if ('nodes' in scene) {
            console.log('üì± [ARJSExporter.generateHTML] Converting from nodes to UPDL scene format')
            scene = this.extractSceneFromUPDLNodes(scene as any)
        }

        // Defaults
        const title = options.title || 'AR.js Scene'
        const markerType = options.markerType || 'pattern'
        const markerValue = options.markerValue || 'hiro'

        // Create a converter instance
        const converter = new UPDLToARJSConverter()

        // Configure marker
        converter.setMarkerOptions(markerType, markerValue)

        // Convert UPDL scene to A-Frame model
        const aframeScene = converter.convertScene(scene)

        // Generate HTML with the AR.js scene
        const htmlGenerator = new ARJSHTMLGenerator()
        const html = htmlGenerator.generateHTML(aframeScene, {
            title,
            includeStats: options.includeStats || false,
            autoRotate: options.autoRotate || false
        })

        return html
    }

    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —É–∑–ª—ã UPDL –≤ —Å—Ü–µ–Ω—É –¥–ª—è AR.js
     * @param data –û–±—ä–µ–∫—Ç —Å —É–∑–ª–∞–º–∏ UPDL
     * @returns –û–±—ä–µ–∫—Ç —Å—Ü–µ–Ω—ã UPDL
     */
    extractSceneFromUPDLNodes(data: any): UPDLScene {
        console.log('üì± [ARJSExporter.extractSceneFromUPDLNodes] Processing nodes', {
            nodeCount: data.nodes?.length || 0
        })

        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ç–æ–∫–µ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        const flowId = data.id || 'unknown-flow'
        const flowName = data.name || 'Unnamed AR.js Scene'

        // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ü–µ–Ω—É
        const scene: UPDLScene = {
            id: flowId,
            name: flowName,
            objects: [],
            cameras: [],
            lights: []
        }

        // –ï—Å–ª–∏ –Ω–µ—Ç —É–∑–ª–æ–≤, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ü–µ–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (!data.nodes || !Array.isArray(data.nodes) || data.nodes.length === 0) {
            console.warn('üì± [ARJSExporter.extractSceneFromUPDLNodes] No nodes found, returning default scene')
            return this.createDefaultScene(flowId, flowName)
        }

        // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–∑–ª—ã UPDL
        const nodes = data.nodes || []

        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —É–∑–ª–∞–º –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è AR.js
        nodes.forEach((node: any, index: number) => {
            try {
                if (!node || !node.type) return

                console.log(`üì± [ARJSExporter.extractSceneFromUPDLNodes] Processing node ${index}:`, node.id || 'unknown', node.type)

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —É–∑–ª–∞
                const nodeData = node.data || {}

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É–∑–ª–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç
                if (node.type.toLowerCase().includes('object')) {
                    // –î–æ–±–∞–≤–ª—è–µ–º 3D –æ–±—ä–µ–∫—Ç
                    const position = nodeData.position || { x: 0, y: 0, z: 0 }
                    const rotation = nodeData.rotation || { x: 0, y: 0, z: 0 }
                    const scale = nodeData.scale || { x: 1, y: 1, z: 1 }
                    const color = nodeData.color || '#FF0000'

                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ü–≤–µ—Ç –∏–∑ —Å—Ç—Ä–æ–∫–∏ hex –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã RGB (0-1)
                    const hexToRgb = (hex: string) => {
                        const r = parseInt(hex.slice(1, 3), 16) / 255
                        const g = parseInt(hex.slice(3, 5), 16) / 255
                        const b = parseInt(hex.slice(5, 7), 16) / 255
                        return { r, g, b }
                    }

                    const rgbColor = typeof color === 'string' ? hexToRgb(color) : { r: 1, g: 0, b: 0 }

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ (box, sphere, cylinder)
                    let objectType = 'box'
                    if (node.type.toLowerCase().includes('sphere')) {
                        objectType = 'sphere'
                    } else if (node.type.toLowerCase().includes('cylinder')) {
                        objectType = 'cylinder'
                    }

                    scene.objects.push({
                        id: node.id || `object-${index}`,
                        name: nodeData.name || `Object ${index}`,
                        type: objectType,
                        position,
                        rotation,
                        scale,
                        color: rgbColor
                    })
                } else if (node.type.toLowerCase().includes('camera')) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–º–µ—Ä—É
                    scene.cameras.push({
                        id: node.id || `camera-${index}`,
                        name: nodeData.name || `Camera ${index}`,
                        type: 'perspective',
                        position: nodeData.position || { x: 0, y: 0, z: 5 },
                        rotation: nodeData.rotation || { x: 0, y: 0, z: 0 },
                        scale: nodeData.scale || { x: 1, y: 1, z: 1 }
                    })
                } else if (node.type.toLowerCase().includes('light')) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞
                    scene.lights.push({
                        id: node.id || `light-${index}`,
                        name: nodeData.name || `Light ${index}`,
                        type: nodeData.type || 'ambient',
                        color: nodeData.color || { r: 1, g: 1, b: 1 },
                        intensity: nodeData.intensity || 1.0,
                        position: nodeData.position || { x: 0, y: 0, z: 0 },
                        rotation: nodeData.rotation || { x: 0, y: 0, z: 0 },
                        scale: nodeData.scale || { x: 1, y: 1, z: 1 }
                    })
                } else if (node.type.toLowerCase().includes('scene')) {
                    // –ï—Å–ª–∏ —ç—Ç–æ —É–∑–µ–ª —Å—Ü–µ–Ω—ã, –∏–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ü–µ–Ω—ã
                    // (–ù–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ–Ω, —Ç—É–º–∞–Ω –∏ —Ç.–¥.)
                    console.log('üì± [ARJSExporter.extractSceneFromUPDLNodes] Found scene node:', node.id)
                }
            } catch (error) {
                console.error(`üì± [ARJSExporter.extractSceneFromUPDLNodes] Error processing node ${index}:`, error)
            }
        })

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ —Å—Ü–µ–Ω–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç
        if (scene.objects.length === 0) {
            console.warn('üì± [ARJSExporter.extractSceneFromUPDLNodes] No objects found, adding default cube')
            scene.objects.push({
                id: 'default-cube',
                name: 'Default Cube',
                type: 'box',
                position: { x: 0, y: 0.5, z: 0 },
                rotation: { x: 0, y: 0, z: 0 },
                scale: { x: 1, y: 1, z: 1 },
                color: { r: 1, g: 0, b: 0 }
            })
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ —Å—Ü–µ–Ω–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–∞–º–µ—Ä–∞
        if (scene.cameras.length === 0) {
            console.warn('üì± [ARJSExporter.extractSceneFromUPDLNodes] No cameras found, adding default camera')
            scene.cameras.push({
                id: 'default-camera',
                name: 'Default Camera',
                type: 'perspective',
                position: { x: 0, y: 0, z: 5 },
                rotation: { x: 0, y: 0, z: 0 },
                scale: { x: 1, y: 1, z: 1 }
            })
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ —Å—Ü–µ–Ω–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞
        if (scene.lights.length === 0) {
            console.warn('üì± [ARJSExporter.extractSceneFromUPDLNodes] No lights found, adding default ambient light')
            scene.lights.push({
                id: 'default-light',
                name: 'Default Ambient Light',
                type: 'ambient',
                color: { r: 1, g: 1, b: 1 },
                intensity: 0.8,
                position: { x: 0, y: 0, z: 0 },
                rotation: { x: 0, y: 0, z: 0 },
                scale: { x: 1, y: 1, z: 1 }
            })
        }

        console.log('üì± [ARJSExporter.extractSceneFromUPDLNodes] Scene generated:', {
            objects: scene.objects.length,
            cameras: scene.cameras.length,
            lights: scene.lights.length
        })

        return scene
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç —Å—Ü–µ–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å –±–∞–∑–æ–≤—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏
     * @param id ID —Å—Ü–µ–Ω—ã
     * @param name –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã
     * @returns –û–±—ä–µ–∫—Ç —Å—Ü–µ–Ω—ã UPDL
     */
    createDefaultScene(id: string, name: string): UPDLScene {
        return {
            id,
            name,
            objects: [
                {
                    id: 'default-box',
                    name: 'Default AR.js Box',
                    type: 'box',
                    position: { x: 0, y: 0.5, z: 0 },
                    rotation: { x: 0, y: 0, z: 0 },
                    scale: { x: 1, y: 1, z: 1 },
                    color: { r: 1, g: 0, b: 0 }
                }
            ],
            cameras: [
                {
                    id: 'default-camera',
                    name: 'Default AR.js Camera',
                    type: 'perspective',
                    position: { x: 0, y: 0, z: 5 },
                    rotation: { x: 0, y: 0, z: 0 },
                    scale: { x: 1, y: 1, z: 1 }
                }
            ],
            lights: [
                {
                    id: 'default-light',
                    name: 'Default AR.js Light',
                    type: 'ambient',
                    color: { r: 1, g: 1, b: 1 },
                    intensity: 0.8,
                    position: { x: 0, y: 0, z: 0 },
                    rotation: { x: 0, y: 0, z: 0 },
                    scale: { x: 1, y: 1, z: 1 }
                }
            ]
        }
    }

    /**
     * Ensures a scene has all required components for AR.js
     * @param scene - UPDL scene to complete
     * @returns Complete UPDL scene for AR.js
     */
    ensureCompleteScene(scene: UPDLScene): UPDLScene {
        if (!scene) return null as any

        const updatedScene = { ...scene }

        // Ensure objects array exists
        if (!updatedScene.objects || !Array.isArray(updatedScene.objects) || updatedScene.objects.length === 0) {
            updatedScene.objects = [
                {
                    id: 'default-box',
                    name: 'Default AR.js Box',
                    type: 'box',
                    position: { x: 0, y: 0, z: 0 },
                    rotation: { x: 0, y: 0, z: 0 },
                    scale: { x: 1, y: 1, z: 1 },
                    color: { r: 1, g: 1, b: 1 }
                }
            ]
        }

        // Ensure cameras array exists
        if (!updatedScene.cameras || !Array.isArray(updatedScene.cameras) || updatedScene.cameras.length === 0) {
            updatedScene.cameras = [
                {
                    id: 'default-camera',
                    name: 'Default AR.js Camera',
                    type: 'perspective',
                    position: { x: 0, y: 0, z: 5 },
                    rotation: { x: 0, y: 0, z: 0 },
                    scale: { x: 1, y: 1, z: 1 }
                }
            ]
        }

        // Ensure lights array exists
        if (!updatedScene.lights || !Array.isArray(updatedScene.lights) || updatedScene.lights.length === 0) {
            updatedScene.lights = [
                {
                    id: 'default-light',
                    name: 'Default AR.js Light',
                    type: 'ambient',
                    color: { r: 1, g: 1, b: 1 },
                    intensity: 0.8,
                    position: { x: 0, y: 0, z: 0 },
                    rotation: { x: 0, y: 0, z: 0 },
                    scale: { x: 1, y: 1, z: 1 }
                }
            ]
        }

        return updatedScene
    }

    /**
     * Validates a UPDL scene for AR.js export
     * @param scene - UPDL scene to validate
     * @returns True if valid for AR.js, false otherwise
     */
    validateScene(scene: UPDLScene): boolean {
        if (!scene) return false
        if (!scene.id) return false

        // Minimal validation - at least needs objects or cameras
        return (
            (scene.objects && Array.isArray(scene.objects) && scene.objects.length > 0) ||
            (scene.cameras && Array.isArray(scene.cameras) && scene.cameras.length > 0)
        )
    }

    /**
     * Handles errors in the AR.js export process
     * @param error - Error to handle
     */
    handleError(error: Error): void {
        console.error('AR.js Exporter Error:', error)
    }

    /**
     * Gets the name of the exporter
     * @returns Exporter name
     */
    getName(): string {
        return 'AR.js'
    }

    /**
     * Gets the description of the exporter
     * @returns Exporter description
     */
    getDescription(): string {
        return 'Exports UPDL scenes to AR.js format for web-based augmented reality'
    }
}

// Create singleton instance
export const arjsExporter = new ARJSExporter()

// Export the class as well for type usage if needed elsewhere, though singleton is preferred for instantiation
export { ARJSExporter }
