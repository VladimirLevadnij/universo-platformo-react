# Фронтенд публикации (publish-frt)

Фронтенд для системы публикации AR.js в Universo Platformo.

## Структура проекта

Проект следует единой структуре всех приложений монорепозитория:

```
apps/publish-frt/base/
├─ package.json
├─ tsconfig.json
├─ gulpfile.ts
└─ src/
   ├─ assets/              # Статические файлы (изображения, иконки)
   │  ├─ icons/            # SVG‑иконки для компонентов и интерфейса
   │  ├─ images/           # Изображения для элементов UI
   │  └─ libs/             # Локальные библиотеки AR.js и A‑Frame для регионов без CDN
   │     ├─ aframe/
   │     │  └─ 1.7.1/      # Файлы A‑Frame 1.7.1
   │     └─ arjs/
   │        └─ 3.4.7/      # Файлы AR.js 3.4.7
   ├─ api/                 # HTTP‑клиенты для взаимодействия с бекендом
   ├─ builders/            # Конвертеры UPDL в целевые платформы
   │  ├─ common/           # Общая инфраструктура билдеров
   │  │  ├─ BaseBuilder.ts          # Абстрактный базовый класс для всех билдеров
   │  │  ├─ BuilderRegistry.ts      # Реестр для управления билдерами
   │  │  ├─ UPDLProcessor.ts        # Обработка UPDL (перенесено из бекенда)
   │  │  ├─ types.ts               # Общие типы и интерфейсы
   │  │  └─ setup.ts               # Настройка регистрации билдеров
   │  ├─ arjs/             # Билдер для AR.js
   │  │  ├─ ARJSBuilder.ts         # Основной класс билдера AR.js
   │  │  ├─ handlers/              # Обработчики для конкретных узлов
   │  │  └─ utils/                 # Утилиты для AR.js
   │  └─ index.ts          # Экспорт билдеров
   ├─ components/          # Презентационные React‑компоненты
   ├─ features/            # Функциональные модули
   ├─ hooks/               # Пользовательские хуки
   ├─ pages/               # Страницы
   ├─ routes/              # Конфигурация маршрутов
   ├─ i18n/                # Локализация
   ├─ services/            # Слой работы с API
   ├─ interfaces/          # Типы и интерфейсы TypeScript
   └─ index.ts             # Точка входа
```

**Система типов**: Типы UPDL импортируются из пакета `@universo/publish-srv`, обеспечивая централизованное управление и консистентность между фронтендом и бекендом.

## Критичная архитектура: рендер в iframe

Контент AR.js должен отображаться через `<iframe>`, чтобы корректно выполнялись скрипты библиотек и не возникало конфликтов с React.

## Архитектура билдеров

Система билдеров предоставляет модульную и расширяемую архитектуру для конвертации пространств UPDL в различные целевые платформы.

#### Ключевые компоненты

-   **BaseBuilder**: Абстрактный базовый класс, который наследуют все билдеры платформ.
-   **BuilderRegistry**: Центральный реестр для управления различными билдерами.
-   **ARJSBuilder**: Конкретная реализация для генерации HTML для AR.js.
-   **Handlers**: Специализированные обработчики для различных типов узлов UPDL (Space, Object, Camera, Light).

## Архитектура обработки UPDL

Фронтенд теперь включает независимые возможности обработки UPDL через класс `UPDLProcessor`, что устраняет зависимости от утилит бекенда.

### Ключевые компоненты

-   **UPDLProcessor**: Центральный класс для обработки потоков UPDL (мигрировал из `packages/server/src/utils/buildUPDLflow.ts`).
-   **Импорт типов**: Типы UPDL импортируются из пакета `@universo/publish-srv`.
-   **Независимость фронтенда**: Полная обработка UPDL на фронтенде без зависимостей от бекенда.

### Возможности

-   **Анализ потока**: Идентифицирует узлы UPDL и конечные узлы.
-   **Обработка цепочек Space**: Обрабатывает сценарии с несколькими пространствами и последовательности сцен.
-   **Интеграция данных**: Обрабатывает узлы Data, связанные с пространствами.
-   **Связи объектов**: Сопоставляет узлы Object с узлами Data.
-   **Типобезопасность**: Полная поддержка TypeScript с централизованными определениями типов.

## Интеграция с бекендом

Приложение поддерживает модульную архитектуру с четким разделением между компонентами фронтенда и бекенда.

### Текущая архитектура

-   **Обработка на фронтенде**: Обработка потоков UPDL выполняется классом `UPDLProcessor` на фронтенде.
-   **API-взаимодействие**: Взаимодействие с бекендом осуществляется исключительно через REST API с использованием клиентов из директории `api/`.
-   **Общие типы**: Типы UPDL централизованы в пакете `@universo/publish-srv` и импортируются фронтендом.
-   **Сервисный слой**: Бекенд предоставляет `FlowDataService` для управления данными потоков.
-   **Независимость**: Отсутствие прямых импортов из `packages/server`, что обеспечивает полную модульную независимость.

### Преимущества миграции

-   **Производительность**: Обработка на фронтенде снижает нагрузку на бекенд.
-   **Модульность**: Четкое разделение ответственности между фронтендом и бекендом.
-   **Типобезопасность**: Централизованные определения типов предотвращают несоответствия.
-   **Масштабируемость**: Фронтенд может независимо обрабатывать сложные потоки UPDL.
-   **Поддержка**: Упрощенная архитектура с меньшим количеством межпакетных зависимостей.

## Создание AR.js‑квиза через UPDL

Квизы строятся цепочкой узлов **Space**. Внутри каждого пространства могут находиться узлы **Data** с вопросами. К вопросу подключаются узлы **Data** с вариантами ответов. Правильные ответы отмечаются полем `isCorrect`; дополнительно можно задать `enablePoints` и `pointsValue` для системы баллов. К узлам ответов могут быть подключены узлы **Object**, которые появляются при выборе ответа.

Spaces связываются через `nextSpace`, образуя цепочку для нескольких вопросов. Пространство без узлов Data может собирать данные пользователя (`collectName`, `collectEmail`, `collectPhone`) и сохранять их в таблицу leads Supabase. Последний Space может включать `showPoints` для отображения итогового количества баллов. Сейчас результат временно сохраняется в поле `phone` таблицы `lead`.

## Основные компоненты

-   `UPDLProcessor` — центральный класс для обработки потоков UPDL (перенесен с бекенда).
-   `ARJSPublisher` — публикация проекта в режиме стриминга с сохранением настроек в Supabase.
-   `ARJSExporter` — демонстрационный экспорт AR.js‑кода.
-   `ARViewPage` — страница просмотра AR‑пространства через iframe.
-   `ARJSBuilder` — модульный билд UPDL в HTML AR.js.

## Архитектура API

Слой API разделён на общие утилиты и клиент публикации. Настройки хранятся в `chatbotConfig` и автоматически сохраняются в Supabase.

## Рабочий процесс

1. Настройки загружаются из Supabase при монтировании компонента.
2. Пользователь настраивает проект — параметры автоматически сохраняются.
3. При включении "Make Public" создаётся публикация и состояние записывается в Supabase.
4. `ARJSPublisher` отправляет POST на `/api/v1/publish/arjs`.
5. При открытии ссылки `/p/{id}` `ARViewPage` запрашивает данные публикации.
6. `UPDLProcessor` анализирует данные потока и преобразует их в структуры UPDL на фронтенде.
7. `ARJSBuilder` конвертирует UPDL в HTML для AR.js.
8. Полученный HTML отображается в iframe.

## Сборка и запуск

```bash
pnpm run dev     # режим разработки
pnpm run build   # сборка
```

Gulp копирует статические ресурсы в каталог dist. Зависимости устанавливаются командой `pnpm install` из корня репозитория.

## Демонстрационный режим

При установке `DEMO_MODE = true` публикация выполняется без обращения к серверу, используется фиксированная ссылка, а Supabase не задействуется.

## Ограничения

-   Нет офлайн‑режима и кэширования.
-   Только маркер "hiro".
-   Экспорт HTML/ZIP реализован частично как демонстрация.

---

_Universo Platformo | Модуль фронтенда публикации_
