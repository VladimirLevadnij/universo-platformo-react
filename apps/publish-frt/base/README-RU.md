# Фронтенд публикации (publish-frt)

Фронтенд для системы публикации AR.js в Universo Platformo.

## Структура проекта

Проект следует единой структуре всех приложений монорепозитория:

``` 
apps/publish-frt/base/
├─ package.json
├─ tsconfig.json
├─ gulpfile.ts
└─ src/
   ├─ assets/              # Статические файлы (изображения, иконки)
   │  ├─ icons/            # SVG‑иконки для компонентов и интерфейса
   │  ├─ images/           # Изображения для элементов UI
   │  └─ libs/             # Локальные библиотеки AR.js и A‑Frame для регионов без CDN
   │     ├─ aframe/
   │     │  └─ 1.7.1/      # Файлы A‑Frame 1.7.1
   │     └─ arjs/
   │        └─ 3.4.7/      # Файлы AR.js 3.4.7
   ├─ api/                 # HTTP‑клиенты для взаимодействия с бекендом
   ├─ builders/            # Конвертеры UPDL в целевые платформы
   ├─ components/          # Презентационные React‑компоненты
   ├─ features/            # Функциональные модули
   ├─ hooks/               # Пользовательские хуки
   ├─ pages/               # Страницы
   ├─ routes/              # Конфигурация маршрутов
   ├─ i18n/                # Локализация
   ├─ services/            # Слой работы с API
   ├─ interfaces/          # Типы и интерфейсы TypeScript
   └─ index.ts             # Точка входа
```

## Критичная архитектура: рендер в iframe

Контент AR.js должен отображаться через `<iframe>`, чтобы корректно выполнялись скрипты библиотек и не возникало конфликтов с React.

## Создание AR.js‑квиза через UPDL

Квизы строятся цепочкой узлов **Space**. Внутри каждого пространства могут находиться узлы **Data** с вопросами. К вопросу подключаются узлы **Data** с вариантами ответов. Правильные ответы отмечаются полем `isCorrect`; дополнительно можно задать `enablePoints` и `pointsValue` для системы баллов. К узлам ответов могут быть подключены узлы **Object**, которые появляются при выборе ответа.

Spaces связываются через `nextSpace`, образуя цепочку для нескольких вопросов. Пространство без узлов Data может собирать данные пользователя (`collectName`, `collectEmail`, `collectPhone`) и сохранять их в таблицу leads Supabase. Последний Space может включать `showPoints` для отображения итогового количества баллов. Сейчас результат временно сохраняется в поле `phone` таблицы `lead`.

## Основные компоненты

- `ARJSPublisher` — публикация проекта в режиме стриминга с сохранением настроек в Supabase
- `ARJSExporter` — демонстрационный экспорт AR.js‑кода
- `ARViewPage` — страница просмотра AR‑пространства через iframe
- `ARJSBuilder` — модульный билд UPDL в HTML AR.js

## Архитектура API

Слой API разделён на общие утилиты и клиент публикации. Настройки хранятся в `chatbotConfig` и автоматически сохраняются в Supabase.

## Рабочий процесс

1. Настройки загружаются из Supabase при монтировании компонента
2. Пользователь настраивает проект — параметры автоматически сохраняются
3. При включении "Make Public" создаётся публикация и состояние записывается в Supabase
4. `ARJSPublisher` отправляет POST на `/api/v1/publish/arjs`
5. При открытии ссылки `/p/{id}` `ARViewPage` запрашивает данные публикации и строит HTML через `ARJSBuilder`
6. Полученный HTML отображается в iframe

## Сборка и запуск

```bash
pnpm run dev     # режим разработки
pnpm run build   # сборка
```

Gulp копирует статические ресурсы в каталог dist. Зависимости устанавливаются командой `pnpm install` из корня репозитория.

## Демонстрационный режим

При установке `DEMO_MODE = true` публикация выполняется без обращения к серверу, используется фиксированная ссылка, а Supabase не задействуется.

## Ограничения

- Нет офлайн‑режима и кэширования
- Только маркер "hiro"
- Экспорт HTML/ZIP реализован частично как демонстрация

---

_Universo Platformo | Модуль фронтенда публикации_
